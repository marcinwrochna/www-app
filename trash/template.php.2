<?php
/*
	template.php
	Included in common.php
	Defines:
		initPage() - initializes global $PAGE SimeplTemplate
			$PAGE->head - stuff to be placed in <head>, usually <script>s
			$PAGE->title - page title, without global site prefix
			$PAGE->menu 
			$PAGE->content
			$PAGE->topContent - just above content, for messages
			$PAGE->js
			$PAGE->jsOnLoad
		outputPage() - output headers and all html
			
		showMessage() - shorthand for displaying short messages
		
		class SimpleTemplate - widely used simple output buffer redirecting and parsing class
			Usage:
				$template = new SimpleTemplate(array('varname' => 'value'));
				$template->varname = 'value';
				?>
					<html>
						Place %varname%s with percent signs to replace with values.
						You can add php functions <?php echo f(); ?> and
						<?php if (true) { ?>
							control structures
						<?php } ?>
						normally.
					</html>
				<?php
				echo $template->finish();
				
		generateFormRows($inputs, $previous=array())
*/


function initPage()
{
	global $PAGE;
	$PAGE = new SimpleTemplate();
	$PAGE->head = '';
	$PAGE->title = '';
	$PAGE->menu = '';
	$PAGE->content = '';
	$PAGE->topContent = '';
	$PAGE->js = '';
	$PAGE->jsOnLoad = '';
}

class SimpleTemplate
{
	public $variables;
	private $cleaned = false;
	
	function __construct($templateVariables = array())
	{		
		$this->variables = $templateVariables;
		ob_start();
	}
	
	public function __get($name)
	{
		if (!array_key_exists($name, $this->variables))
		{
			$this->variables[$name] = '';
		}
		return $this->variables[$name];
	}
	
	public function __set($name, $value)
	{
		$this->variables[$name] = $value;
	}
	
	function finish()
	{
		if ($this->cleaned)  return 'Błąd parsera.';
		
		$names = array();
		$values = array();
		foreach ($this->variables as $name => $value)
		{
			$names[]= "%$name%";
			$values[]= $value;
		}
		$this->cleaned = true;
		return str_replace($names, $values, ob_get_clean());
	}

	function __destruct()
	{
		if (!$this->cleaned && ob_get_level())  ob_end_clean();
	}
}

function showMessage($text, $type='unknown')
{
	//type in ('success', 'userError', 'instruction', 'exception')
	global $PAGE;
	$PAGE->topContent .= "<div class='contentBox message'>$text</div>";
}

function outputPage()
{	
	global $PAGE;
	header('Content-Language: pl');
	header('Content-Type: text/html; charset=UTF-8'); 
	
	// Too frequent version changes make things incompatible. Must-revalidate.
	header('Cache-Control: private, s-maxage=0, max-age=0, must-revalidate');
	header('Last-Modified: '. gmdate("D, d M Y H:i:s", time()) .' GMT');

	if (DEBUG>=2) $PAGE->content .= dumpSuperGlobals();

?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="pl" lang="pl" dir="ltr">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<!--<meta name="keywords" content="" />
	<meta name="description" content="" />
	<meta name="author" content="" />-->
	
	<!--<link rel="icon" type="image/png" href="%[/images/favicon.png]%" />-->
	<!--<link rel="alternate" type="application/atom+xml" href="%[atom.php,lang=-]%" title="Atom feed" />-->
	<link rel="stylesheet" type="text/css" href="css.css" />
	<title>WWW - %title%</title>

	%head%
	<script type="text/javascript" src="tinymce/tiny_mce.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
	<script type="text/javascript"><!--
		%js%
		
		function setDisplay(id, val)
		{
			document.getElementById(id).style.display = val?'':'none';
		}
		
		$(document).ready(function(){   
			%jsOnLoad%
			tinyMCE.init({
				language: "pl",
				mode : "specific_textareas",
				editor_selector : "mceEditor",
				plugins: "nonbreaking",
				nonbreaking_force_tab : "true",
				entity_encoding : "raw",
				theme: "advanced",
				theme_advanced_toolbar_location: "top",
				theme_advanced_buttons1 :
					 "bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,bullist,numlist,separator,undo,redo,|,link,unlink,image,hr", 
				theme_advanced_buttons2 : "formatselect,fontsizeselect,|,charmap,sub,sup,outdent,indent,|,removeformat,code,|,forecolor,backcolor,", 
				theme_advanced_buttons3 : "",
				theme_advanced_blockformats : "p,h3,h4,h5,h6,pre,div", //blockquote,address,samp,dd,dt
				indentation: "20px"
		 	});
		});
	--></script>
	<!--[if lt IE 7]>
		<script src="http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js" type="text/javascript"></script>
		<style type="text/css">
			body { behavior: url("iecsshover3.htc"); }
		</style>
	<![endif]-->

</head>
<body>
	<div id="globalContainer">
		<div id="headerBox"><h1><a href="index.php">
			<img src="images/logo.gif" alt="Wakacyjne Warsztaty Wielodyscyplinarne" />
		</a></h1></div>

		<div id="middleContainer">
			<div id="contentBoxMargin"><div id="contentBox">
				%topContent%
				%content%
			</div></div>

			<div id="menuPanel">
				<h2 style="display:none;">menu</h2>
				%menu%
			</div>
		</div>
		
		<div id="footerBox" >
			&copy; <?php echo strftime("%Y"); ?> Wakacyjne Warsztaty Wielodyscyplinarne
		</div>
	</div>
	
	<script type="text/javascript">
		var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
		document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
	</script>
	<script type="text/javascript">
		try
		{
			var pageTracker = _gat._getTracker("UA-12926426-2");
			pageTracker._trackPageview();
		} catch(err) {}
	</script>
</body>
</html>
	<?php
	echo $PAGE->finish();
}


function generateFormRows($inputs, $previous=array())
{
	foreach ($inputs as $row)
	{
		if (isset($row['name']))  $arguments = $row;
		else  $arguments = array('type'=>$row[2], 'name'=>$row[1], 'description'=>$row[0]);
		if (isset($previous[$arguments['name']]) && !isset($arguments['default']))
			$arguments['default'] = $previous[$arguments['name']];
		buildFormRow($arguments);
	}
}

define('VALUE_OTHER', -66642);
function buildFormRow($type, $name=NULL, $description=NULL, $default=NULL, $options=array(), $ignorePOST=false)
{
	// Handle named arguments.
	if (is_array($type))
		foreach ($type as $key => $val)
			$$key = $val;
			
	if (!isset($properties))  $properties = '';
	if (!isset($readonly))    $readonly = false;
		
	$rtype = $type;
	if (isset($_POST[$name]) && !$ignorePOST)  $default = $_POST[$name];
	
	$row = "<tr id='row_$name'>";
	if ($readonly)
	{
		if (is_array($default)) 
		{
			$tmp = array();
			if (!empty($options))
				foreach($default as $d)  $tmp[]= $options[$d];
			$default = implode(', ', $tmp);
		}
		if ($type == 'timestamp')  $default = strftime('%Y-%m-%d %T', $default);
		$row .= "<td><label>$description</label></td>";
		$row .= "<td><span $properties>$default</span></td>";
	}
	else switch ($type)
	{
		case 'textarea':
		case 'richtextarea':
			$row .=  "<td colspan='2'>";
			$row .= "<label for='$name'>$description</label>";
			$height = ($type=='textarea') ? 2 : 20;
			$class  = ($type=='textarea') ? '' : 'class="mceEditor"';
			$row .= "<br/><textarea rows='$height' name='$name' $class $properties>";
			$row .= htmlspecialchars($default);
			$row .= "</textarea>";
			$row .= "</td>";
			break;
		case 'readonly':
			$row .= "<td><label>$description</label></td>";
			$row .= "<td><span $properties>$default</span></td>";
			break;
		case 'select':
			if (isset($other))
			{
				$options[VALUE_OTHER] = 'inny...';
				$otherIndex = count($options)-1;
				$properties .= 'onChange="setDisplay(\'row_'. $name .'_other\','.
					'this.selectedIndex=='. $otherIndex .')"';
			}
		
			$row .= "<td><label for='$name'>$description</label></td>";
			$row .= "<td><select name='$name' $properties>";
			$foundSelected = false;
			foreach ($options as $val=>$option)
			{
				if (!$foundSelected && $val == VALUE_OTHER) 
				{
					$selected = 'selected="selected"';					
				}
				else if ($val == $default) 
				{
					$selected = 'selected="selected"';
					$foundSelected = true;
				}
				else $selected = '';
				$row .= "<option value='$val' $selected>$option</option>";
			}
			
			if (!$foundSelected && $default && !isset($other))
				$row .= "<option value='$default' selected='selected'>inne ($default)</option>";			
				
			$row .= "</select></td>";
			break;
		case 'checkboxgroup':
			$i = 1;
			$name = $name .'[]';
			$row .= "<td><label for='$name'>$description</label></td><td>";
			foreach ($options as $val=>$option)
			{
				$row .= "<input type='checkbox' class='checkbox' name='$name' value='$val' ";
				if (is_array($default) && in_array($val, $default))  $row .= 'checked="checked" ';
				$row .= "/>$option";				
				if (!($i%3))  $row .= "<br/>";
				$i++;
			}
			$row .= "</td>";
			break;
		case 'custom':
			$row .= "<td><label for='$name'>$description</label></td><td>$custom</td>";
			break;
		case 'int': 			
		case 'timestamp':
			$type = 'text';
		default:
			$row .= "<td><label for='$name'>$description</label></td>";
			$row .= "<td><input type='$type' name='$name' $properties ";
			if ($type == 'checkbox')
			{
				if (!empty($default) && $default!='0')
					$row .= ' checked="checked"';
				$row .= ' value="1"';
			}
			else if ($default)
				$row .= ' value="'. htmlspecialchars($default) .'"';
			if ($rtype == 'int')  $row .= ' size="4"';
			else if ($rtype == 'text' || $rtype == 'timestamp')  $row .= ' class="text"';
			$row .= " />"; 
			if ($rtype == 'timestamp')  $row .= '<small><i>YYYY-MM-DD HH:MM</i> lub <i>YYYY-MM-DD</i></small>';
			$row .= "</td>";
	}
	echo $row . "</tr>";
	if (isset($other))
	{
		buildFormRow(array('name'=>"{$name}_other", 'description'=>" &nbsp; &nbsp; &nbsp; $other",
					'type'=>'text', 'default'=>$default));
		global $PAGE;
		if ($foundSelected)
			$PAGE->jsOnLoad .= 'document.getElementById("row_'. $name .'_other").style.display = "none";';					
	}
}
