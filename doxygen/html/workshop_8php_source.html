<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>wwwApp: workshop.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">wwwApp</div>
   <div id="projectbrief">A web app for workshop organizing, recruitment and qualification</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">workshop.php</div>  </div>
</div>
<div class="contents">
<a href="workshop_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 <span class="comment">/*</span>
<a name="l00003"></a>00003 <span class="comment"> * workshop.php</span>
<a name="l00004"></a>00004 <span class="comment"> */</span>
<a name="l00005"></a>00005 require_once(<span class="stringliteral">&#39;tasks.php&#39;</span>);
<a name="l00006"></a>00006 
<a name="l00010"></a><a class="code" href="workshop_8php.html#aa02cf384e084e2082688ac6f0fa9b576">00010</a> function <a class="code" href="workshop_8php.html#aa02cf384e084e2082688ac6f0fa9b576">addWarsztatyMenuBox</a>()
<a name="l00011"></a>00011 {
<a name="l00012"></a>00012         global <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>;
<a name="l00013"></a>00013         $PAGE-&gt;addMenuBox(<span class="stringliteral">&#39;Warsztaty&#39;</span>, <a class="code" href="utils_8php.html#ae70693a7d9a8484219fe57bdf2d2a46f">parseTable</a>(<span class="stringliteral">&#39;</span>
<a name="l00014"></a>00014 <span class="stringliteral">                ACTION              =&gt; tTitle;                     ICON;</span>
<a name="l00015"></a>00015 <span class="stringliteral">                listPublicWorkshops =&gt; workshop list;              brick.png;</span>
<a name="l00016"></a>00016 <span class="stringliteral">                listOwnWorkshops    =&gt; your workshops;             brick-green.png;</span>
<a name="l00017"></a>00017 <span class="stringliteral">                createWorkshop      =&gt; propose new workshops;      brick-add.png;</span>
<a name="l00018"></a>00018 <span class="stringliteral">        &#39;</span>));
<a name="l00019"></a>00019 }
<a name="l00020"></a>00020 
<a name="l00026"></a><a class="code" href="workshop_8php.html#adbee1dd1cb134665df5762397165a698">00026</a> function <a class="code" href="workshop_8php.html#adbee1dd1cb134665df5762397165a698">actionListPublicWorkshops</a>()
<a name="l00027"></a>00027 {
<a name="l00028"></a>00028         global <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>, $USER, <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>;
<a name="l00029"></a>00029         <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;listPublicWorkshops&#39;</span>))  <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classPolicyException.html">PolicyException</a>();
<a name="l00030"></a>00030         $PAGE-&gt;title = _(<span class="stringliteral">&#39;Workshop list&#39;</span>);
<a name="l00031"></a>00031         <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a5bbc4a39c360e15b0c00714f18d2082b">assertProfileFilled</a>())  <span class="keywordflow">return</span>;
<a name="l00032"></a>00032 
<a name="l00033"></a>00033         <span class="comment">// Inform how many hours of workshops did the user sign up for.</span>
<a name="l00034"></a>00034         $DB-&gt;query(<span class="stringliteral">&#39;SELECT SUM(w.duration)</span>
<a name="l00035"></a>00035 <span class="stringliteral">                FROM table_workshops w, table_workshop_users wu</span>
<a name="l00036"></a>00036 <span class="stringliteral">                WHERE w.status=$1 AND w.edition=$2 AND wu.wid=w.wid AND wu.uid=$3&#39;</span>,
<a name="l00037"></a>00037                 enumBlockStatus(<span class="stringliteral">&#39;accepted&#39;</span>)-&gt;<span class="keywordtype">id</span>, <a class="code" href="utils_8php.html#a86acce3c002ca1af709fd1b04f2f82fa">getOption</a>(<span class="stringliteral">&#39;currentEdition&#39;</span>), $USER[<span class="stringliteral">&#39;uid&#39;</span>]);
<a name="l00038"></a>00038         $sum = intval($DB-&gt;fetch());
<a name="l00039"></a>00039         <span class="keywordflow">if</span> ($sum)
<a name="l00040"></a>00040         {
<a name="l00041"></a>00041                 $msg = sprintf(<a class="code" href="user_2utils_8php.html#a7144fa5a413ad5690425b7b720aeedba">genderize</a>(_(<span class="stringliteral">&#39;You signed up for %d x 1,5 hours of workshops.&#39;</span>)), $sum);
<a name="l00042"></a>00042                 <span class="keywordflow">if</span> ($sum&gt;30)  $msg .= <span class="stringliteral">&#39;&lt;br/&gt;&#39;</span>. _(<span class="stringliteral">&#39;Remember that WWW has approximately 36 x 1,5 hours in total.&#39;</span>);
<a name="l00043"></a>00043                 $PAGE-&gt;addMessage($msg, <span class="stringliteral">&#39;info&#39;</span>);
<a name="l00044"></a>00044         }
<a name="l00045"></a>00045 
<a name="l00046"></a>00046         <span class="comment">// Public workshops = workshops with type:workshop and status:accepted.</span>
<a name="l00047"></a>00047         <a class="code" href="workshop_8php.html#a6a380b691dafabf6af1a71981468f083">listWorkshops</a>(<span class="stringliteral">&#39;Public&#39;</span>,
<a name="l00048"></a>00048                 <span class="stringliteral">&#39;(type=&#39;</span>.  enumBlockType(<span class="stringliteral">&#39;workshop&#39;</span>)-&gt;<span class="keywordtype">id</span> .<span class="stringliteral">&#39; AND &#39;</span>.
<a name="l00049"></a>00049                 <span class="stringliteral">&#39;status=&#39;</span>. enumBlockStatus(<span class="stringliteral">&#39;accepted&#39;</span>)-&gt;<span class="keywordtype">id</span> .<span class="charliteral">&#39;)&#39;</span>,
<a name="l00050"></a>00050                 array(<span class="stringliteral">&#39;wid&#39;</span>,<span class="stringliteral">&#39;lecturers&#39;</span>,<span class="stringliteral">&#39;title&#39;</span>,<span class="stringliteral">&#39;subject&#39;</span>,<span class="stringliteral">&#39;duration&#39;</span>,<span class="stringliteral">&#39;participants&#39;</span>));
<a name="l00051"></a>00051 }
<a name="l00052"></a>00052 
<a name="l00057"></a><a class="code" href="workshop_8php.html#aa0a23a469eaf27d4e25fcd9899232005">00057</a> function <a class="code" href="workshop_8php.html#aa0a23a469eaf27d4e25fcd9899232005">actionListOwnWorkshops</a>()
<a name="l00058"></a>00058 {
<a name="l00059"></a>00059         global $USER, <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>;
<a name="l00060"></a>00060         <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;listOwnWorkshops&#39;</span>))  <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classPolicyException.html">PolicyException</a>();
<a name="l00061"></a>00061         $PAGE-&gt;title = _(<span class="stringliteral">&#39;Your workshops&#39;</span>);
<a name="l00062"></a>00062         $where = <span class="stringliteral">&#39;EXISTS (SELECT wu.uid FROM table_workshop_users wu WHERE wu.uid=&#39;</span>. $USER[<span class="stringliteral">&#39;uid&#39;</span>].<span class="stringliteral">&#39;</span>
<a name="l00063"></a>00063 <span class="stringliteral">                AND wu.wid = w.wid AND wu.participant=&#39;</span>. enumParticipantStatus(<span class="stringliteral">&#39;lecturer&#39;</span>)-&gt;id .<span class="charliteral">&#39;)&#39;</span>;
<a name="l00064"></a>00064         <a class="code" href="workshop_8php.html#a6a380b691dafabf6af1a71981468f083">listWorkshops</a>(<span class="stringliteral">&#39;Own&#39;</span>, $where,
<a name="l00065"></a>00065                 array(<span class="stringliteral">&#39;wid&#39;</span>,<span class="stringliteral">&#39;lecturers&#39;</span>,<span class="stringliteral">&#39;title&#39;</span>,<span class="stringliteral">&#39;type&#39;</span>,<span class="stringliteral">&#39;subject&#39;</span>,<span class="stringliteral">&#39;duration&#39;</span>,<span class="stringliteral">&#39;status&#39;</span>,<span class="stringliteral">&#39;participants&#39;</span>));
<a name="l00066"></a>00066 }
<a name="l00067"></a>00067 
<a name="l00072"></a><a class="code" href="workshop_8php.html#ac3693909fdfeb9db13ae3a9bb96f5c23">00072</a> function <a class="code" href="workshop_8php.html#ac3693909fdfeb9db13ae3a9bb96f5c23">actionListAllWorkshops</a>()
<a name="l00073"></a>00073 {
<a name="l00074"></a>00074         global <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>;
<a name="l00075"></a>00075         <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;listAllWorkshops&#39;</span>))  <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classPolicyException.html">PolicyException</a>();
<a name="l00076"></a>00076         $PAGE-&gt;title = _(<span class="stringliteral">&#39;All workshops&#39;</span>);
<a name="l00077"></a>00077         <a class="code" href="workshop_8php.html#a6a380b691dafabf6af1a71981468f083">listWorkshops</a>(<span class="stringliteral">&#39;All&#39;</span>, <span class="stringliteral">&#39;&#39;</span>,
<a name="l00078"></a>00078                 array(<span class="stringliteral">&#39;wid&#39;</span>,<span class="stringliteral">&#39;lecturers&#39;</span>,<span class="stringliteral">&#39;title&#39;</span>,<span class="stringliteral">&#39;type&#39;</span>,<span class="stringliteral">&#39;subject&#39;</span>,<span class="stringliteral">&#39;duration&#39;</span>,<span class="stringliteral">&#39;status&#39;</span>,<span class="stringliteral">&#39;participants&#39;</span>));
<a name="l00079"></a>00079 }
<a name="l00080"></a>00080 
<a name="l00088"></a><a class="code" href="workshop_8php.html#a6a380b691dafabf6af1a71981468f083">00088</a> function <a class="code" href="workshop_8php.html#a6a380b691dafabf6af1a71981468f083">listWorkshops</a>($which, $where, $columns)
<a name="l00089"></a>00089 {
<a name="l00090"></a>00090         global $USER, <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>, <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>;
<a name="l00091"></a>00091 
<a name="l00092"></a>00092         $cols = <a class="code" href="utils_8php.html#ae70693a7d9a8484219fe57bdf2d2a46f">parseTable</a>(<span class="stringliteral">&#39;</span>
<a name="l00093"></a>00093 <span class="stringliteral">                COLUMN        =&gt; tTH;             ORDER;</span>
<a name="l00094"></a>00094 <span class="stringliteral">                wid           =&gt; #;               w.wid;</span>
<a name="l00095"></a>00095 <span class="stringliteral">                lecturers     =&gt; lecturers;       lecturers;</span>
<a name="l00096"></a>00096 <span class="stringliteral">                title         =&gt; title;           w.title;</span>
<a name="l00097"></a>00097 <span class="stringliteral">                type          =&gt; type;            w.type;</span>
<a name="l00098"></a>00098 <span class="stringliteral">                subject       =&gt; subjects;        w.subjects_order;</span>
<a name="l00099"></a>00099 <span class="stringliteral">                duration      =&gt; duration [1.5h]; w.duration DESC;</span>
<a name="l00100"></a>00100 <span class="stringliteral">                status        =&gt; status;          w.status;</span>
<a name="l00101"></a>00101 <span class="stringliteral">                participants  =&gt; signups;         count_accepted DESC;</span>
<a name="l00102"></a>00102 <span class="stringliteral">        &#39;</span>);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104         $from = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00105"></a>00105         $whereClauses = array();
<a name="l00106"></a>00106         $orderby = array();
<a name="l00107"></a>00107         <span class="comment">/* ORDER BY (remember in SESSION, keep stabile, special order when ordering by lecturers) */</span>
<a name="l00108"></a>00108         $allowed = array();
<a name="l00109"></a>00109         <span class="keywordflow">foreach</span> ($cols as $col)  <span class="keywordflow">if</span> ($col[<span class="stringliteral">&#39;order&#39;</span>] != <span class="stringliteral">&#39;lecturers&#39;</span>)  $allowed[]= $col[<span class="stringliteral">&#39;order&#39;</span>];
<a name="l00110"></a>00110         <span class="keywordflow">if</span> (!isset($_SESSION[<span class="stringliteral">&#39;workshopOrder&#39;</span>]))  $_SESSION[<span class="stringliteral">&#39;workshopOrder&#39;</span>] = array();
<a name="l00111"></a>00111         <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;order&#39;</span>]) &amp;&amp; $_GET[<span class="stringliteral">&#39;order&#39;</span>] ==<span class="stringliteral">&#39;lecturers&#39;</span>)
<a name="l00112"></a>00112         {
<a name="l00113"></a>00113                 $orderby[] = <span class="stringliteral">&#39;u.ordername&#39;</span>;
<a name="l00114"></a>00114                 $from = <span class="stringliteral">&#39;, table_users u&#39;</span>;
<a name="l00115"></a>00115                 $whereClauses[] = <span class="stringliteral">&#39;EXISTS (SELECT * FROM table_workshop_users wu</span>
<a name="l00116"></a>00116 <span class="stringliteral">                        WHERE w.wid=wu.wid AND u.uid=wu.uid</span>
<a name="l00117"></a>00117 <span class="stringliteral">                                AND participant=&#39;</span>. enumParticipantStatus(<span class="stringliteral">&#39;lecturer&#39;</span>)-&gt;id .<span class="charliteral">&#39;)&#39;</span>;
<a name="l00118"></a>00118                 $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;When sorting by lecturers, common workshops are shown repeatedly.&#39;</span>), <span class="stringliteral">&#39;info&#39;</span>);
<a name="l00119"></a>00119         }
<a name="l00120"></a>00120         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;order&#39;</span>]))
<a name="l00121"></a>00121                 $_SESSION[<span class="stringliteral">&#39;workshopOrder&#39;</span>][]= $_GET[<span class="stringliteral">&#39;order&#39;</span>];
<a name="l00122"></a>00122         <span class="keywordflow">while</span> (count($_SESSION[<span class="stringliteral">&#39;workshopOrder&#39;</span>]) &gt; 3)
<a name="l00123"></a>00123                 array_shift($_SESSION[<span class="stringliteral">&#39;workshopOrder&#39;</span>]);
<a name="l00124"></a>00124 
<a name="l00125"></a>00125         $orderClauses = array_reverse($_SESSION[<span class="stringliteral">&#39;workshopOrder&#39;</span>]);
<a name="l00126"></a>00126         $orderClauses[]= <span class="stringliteral">&#39;w.title&#39;</span>;
<a name="l00127"></a>00127         <span class="keywordflow">foreach</span> ($orderClauses as $o)
<a name="l00128"></a>00128                 <span class="keywordflow">if</span> (in_array($o, $allowed, <span class="keyword">true</span>) &amp;&amp; !in_array($o, $orderby))
<a name="l00129"></a>00129                         $orderby[]= $o;
<a name="l00130"></a>00130         $orderby = implode(<span class="charliteral">&#39;,&#39;</span>, $orderby);
<a name="l00131"></a>00131 
<a name="l00132"></a>00132         <span class="comment">/* WHERE (current editions, restriction to subject) */</span>
<a name="l00133"></a>00133         <span class="keywordflow">if</span> (!empty($where))  $whereClauses[]= $where;
<a name="l00134"></a>00134         $whereClauses[]= <span class="stringliteral">&#39;w.edition=&#39;</span>. intval(<a class="code" href="utils_8php.html#a86acce3c002ca1af709fd1b04f2f82fa">getOption</a>(<span class="stringliteral">&#39;currentEdition&#39;</span>));
<a name="l00135"></a>00135         <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;subject&#39;</span>]) &amp;&amp; enumSubject()-&gt;exists($_GET[<span class="stringliteral">&#39;subject&#39;</span>]))
<a name="l00136"></a>00136                 $whereClauses[]= <span class="stringliteral">&#39;EXISTS (SELECT * FROM table_workshop_subjects ws</span>
<a name="l00137"></a>00137 <span class="stringliteral">                        WHERE ws.wid=w.wid AND ws.subject=\&#39;&#39;</span>. $_GET[<span class="stringliteral">&#39;subject&#39;</span>] .<span class="charliteral">&#39;\&#39;</span>)<span class="stringliteral">&#39;;</span>
<a name="l00138"></a>00138 <span class="stringliteral">        if (!empty($whereClauses))  $where = &#39;</span>WHERE <span class="stringliteral">&#39;. implode(&#39;</span> AND <span class="stringliteral">&#39;, $whereClauses);</span>
<a name="l00139"></a>00139 <span class="stringliteral">        else $where = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00140"></a>00140 <span class="stringliteral"></span>
<a name="l00141"></a>00141 <span class="stringliteral">        /* SELECT (participant counts by status) */</span>
<a name="l00142"></a>00142 <span class="stringliteral">        $selectParticipants = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00143"></a>00143 <span class="stringliteral">        foreach (enumParticipantStatus() as $statusName =&gt; $status)</span>
<a name="l00144"></a>00144 <span class="stringliteral">                $selectParticipants .= &#39;</span>(SELECT COUNT(*) FROM table_workshop_users wu
<a name="l00145"></a>00145                         WHERE wu.wid=w.wid AND participant=<span class="stringliteral">&#39;. $status-&gt;id .&#39;</span>) AS count_<span class="stringliteral">&#39;. $statusName .&#39;</span>,<span class="stringliteral">&#39;;</span>
<a name="l00146"></a>00146 <span class="stringliteral"></span>
<a name="l00147"></a>00147 <span class="stringliteral"></span>
<a name="l00148"></a>00148 <span class="stringliteral">        $workshops = $DB-&gt;query(&#39;</span>
<a name="l00149"></a>00149                 SELECT w.wid, w.title, w.status, w.type, w.duration, w.link,
<a name="l00150"></a>00150                         <span class="stringliteral">&#39;. $selectParticipants .&#39;</span>
<a name="l00151"></a>00151                         (SELECT participant FROM table_workshop_users wu
<a name="l00152"></a>00152                          WHERE wu.wid=w.wid AND wu.uid=$1) AS participant
<a name="l00153"></a>00153                 FROM table_workshops w<span class="stringliteral">&#39;. $from .&#39;</span>
<a name="l00154"></a>00154                 <span class="stringliteral">&#39;. $where .&#39;</span>
<a name="l00155"></a>00155                 ORDER BY w.edition DESC, <span class="stringliteral">&#39;. $orderby, $USER[&#39;</span>uid<span class="stringliteral">&#39;]);</span>
<a name="l00156"></a>00156 <span class="stringliteral"></span>
<a name="l00157"></a>00157 <span class="stringliteral">        $PAGE-&gt;headerTitle = &quot;&lt;h2&gt;&lt;a href=&#39;</span>list${which}Workshops<span class="stringliteral">&#39;&gt;&quot;. $PAGE-&gt;title . &quot;&lt;/a&gt;&lt;/h2&gt;&quot;;</span>
<a name="l00158"></a>00158 <span class="stringliteral">        echo &quot;&lt;table class=&#39;</span>workshopList<span class="stringliteral">&#39;&gt;&quot;;</span>
<a name="l00159"></a>00159 <span class="stringliteral">        echo &quot;&lt;thead&gt;&lt;tr&gt;&quot;;</span>
<a name="l00160"></a>00160 <span class="stringliteral">        foreach ($columns as $c)</span>
<a name="l00161"></a>00161 <span class="stringliteral">        {</span>
<a name="l00162"></a>00162 <span class="stringliteral">                $th = $cols[$c][&#39;</span>th<span class="stringliteral">&#39;];</span>
<a name="l00163"></a>00163 <span class="stringliteral">                $order = htmlspecialchars(urlencode($cols[$c][&#39;</span>order<span class="stringliteral">&#39;]), ENT_QUOTES);</span>
<a name="l00164"></a>00164 <span class="stringliteral">                echo &quot;&lt;th&gt;&lt;a href=&#39;</span>list${which}Workshops?order=$order<span class="stringliteral">&#39;&gt;$th&lt;/a&gt;&lt;/th&gt;&quot;;</span>
<a name="l00165"></a>00165 <span class="stringliteral">        }</span>
<a name="l00166"></a>00166 <span class="stringliteral">        echo &quot;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&quot;;</span>
<a name="l00167"></a>00167 <span class="stringliteral">        foreach ($workshops as $row)</span>
<a name="l00168"></a>00168 <span class="stringliteral">        {</span>
<a name="l00169"></a>00169 <span class="stringliteral">                $status = enumBlockStatus(intval($row[&#39;</span>status<span class="stringliteral">&#39;]));</span>
<a name="l00170"></a>00170 <span class="stringliteral">                $row[&#39;</span>status<span class="stringliteral">&#39;] = userCan(&#39;</span>changeWorkshopStatus<span class="stringliteral">&#39;) ? $status-&gt;decision : $status-&gt;status;</span>
<a name="l00171"></a>00171 <span class="stringliteral">                $row[&#39;</span>status<span class="stringliteral">&#39;] = str_replace(&#39;</span> <span class="charliteral">&#39;,&#39;</span>&amp;nbsp;<span class="stringliteral">&#39;, $row[&#39;</span>status<span class="stringliteral">&#39;]);</span>
<a name="l00172"></a>00172 <span class="stringliteral"></span>
<a name="l00173"></a>00173 <span class="stringliteral">                $row[&#39;</span>lecturers<span class="stringliteral">&#39;] = array();</span>
<a name="l00174"></a>00174 <span class="stringliteral">                foreach (getLecturers($row[&#39;</span>wid<span class="stringliteral">&#39;]) as $lecturer)</span>
<a name="l00175"></a>00175 <span class="stringliteral">                        $row[&#39;</span>lecturers<span class="stringliteral">&#39;][]= getUserBadge($lecturer);</span>
<a name="l00176"></a>00176 <span class="stringliteral">                $row[&#39;</span>lecturers<span class="stringliteral">&#39;] = implode(&#39;</span>,&lt;br/&gt;<span class="stringliteral">&#39;, $row[&#39;</span>lecturers<span class="stringliteral">&#39;]);</span>
<a name="l00177"></a>00177 <span class="stringliteral"></span>
<a name="l00178"></a>00178 <span class="stringliteral">                $row[&#39;</span>type<span class="stringliteral">&#39;] = enumBlockType(intval($row[&#39;</span>type<span class="stringliteral">&#39;]))-&gt;short;</span>
<a name="l00179"></a>00179 <span class="stringliteral"></span>
<a name="l00180"></a>00180 <span class="stringliteral">                $subjects = $DB-&gt;query(&#39;</span>
<a name="l00181"></a>00181                         SELECT subject FROM table_workshop_subjects
<a name="l00182"></a>00182                         WHERE wid=$1 ORDER BY subject<span class="stringliteral">&#39;, $row[&#39;</span>wid<span class="stringliteral">&#39;])-&gt;fetch_column();</span>
<a name="l00183"></a>00183 <span class="stringliteral">                $row[&#39;</span>subject<span class="stringliteral">&#39;] = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00184"></a>00184 <span class="stringliteral">                foreach ($subjects as $subject)</span>
<a name="l00185"></a>00185 <span class="stringliteral">                {</span>
<a name="l00186"></a>00186 <span class="stringliteral">                        $s = enumSubject($subject);</span>
<a name="l00187"></a>00187 <span class="stringliteral">                        $row[&#39;</span>subject<span class="stringliteral">&#39;] .= getIcon(&#39;</span>subject-<span class="stringliteral">&#39;. $s-&gt;icon .&#39;</span>.png<span class="stringliteral">&#39;, $s-&gt;description,</span>
<a name="l00188"></a>00188 <span class="stringliteral">                         &quot;list${which}Workshops?subject=$subject&quot;);</span>
<a name="l00189"></a>00189 <span class="stringliteral">                }</span>
<a name="l00190"></a>00190 <span class="stringliteral"></span>
<a name="l00191"></a>00191 <span class="stringliteral">                $row[&#39;</span>title<span class="stringliteral">&#39;] = &quot;&lt;a href=&#39;</span>showWorkshop(${row[<span class="stringliteral">&#39;wid&#39;</span>]})<span class="stringliteral">&#39;&gt;${row[&#39;</span>title<span class="stringliteral">&#39;]}&lt;/a&gt;&quot;;</span>
<a name="l00192"></a>00192 <span class="stringliteral"></span>
<a name="l00193"></a>00193 <span class="stringliteral">                $row[&#39;</span>participants<span class="stringliteral">&#39;] = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00194"></a>00194 <span class="stringliteral">                if (userCan(&#39;</span>showWorkshopParticipants<span class="stringliteral">&#39;, getLecturers($row[&#39;</span>wid<span class="stringliteral">&#39;])))</span>
<a name="l00195"></a>00195 <span class="stringliteral">                {</span>
<a name="l00196"></a>00196 <span class="stringliteral">                        $tip = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00197"></a>00197 <span class="stringliteral">                        // TODO i18n polish plural -ych</span>
<a name="l00198"></a>00198 <span class="stringliteral">                        foreach (enumParticipantStatus() as $statusName =&gt; $status)</span>
<a name="l00199"></a>00199 <span class="stringliteral">                                $tip .= str_replace(&#39;</span>%<span class="charliteral">&#39;,&#39;</span>ych<span class="stringliteral">&#39;,$status-&gt;description) .&#39;</span>: <span class="stringliteral">&#39;. $row[&quot;count_$statusName&quot;] .&#39;</span>&lt;br/&gt;<span class="stringliteral">&#39;;</span>
<a name="l00200"></a>00200 <span class="stringliteral">                        $row[&#39;</span>participants<span class="stringliteral">&#39;] .= &#39;</span>&lt;a <span class="stringliteral">&#39;. getTipJS($tip) .&#39;</span>&gt;<span class="stringliteral">&#39;;</span>
<a name="l00201"></a>00201 <span class="stringliteral">                        $row[&#39;</span>participants<span class="stringliteral">&#39;] .= ($row[&#39;</span>count_accepted<span class="stringliteral">&#39;] + $row[&#39;</span>count_autoaccepted<span class="stringliteral">&#39;]) .&#39;</span>&lt;/a&gt;<span class="stringliteral">&#39;;</span>
<a name="l00202"></a>00202 <span class="stringliteral">                }</span>
<a name="l00203"></a>00203 <span class="stringliteral"></span>
<a name="l00204"></a>00204 <span class="stringliteral">                $participant = enumParticipantStatus(intval($row[&#39;</span>participant<span class="stringliteral">&#39;]));</span>
<a name="l00205"></a>00205 <span class="stringliteral">                if (isset($participant-&gt;icon))</span>
<a name="l00206"></a>00206 <span class="stringliteral">                        $row[&#39;</span>participants<span class="stringliteral">&#39;] .= &#39;</span> <span class="stringliteral">&#39;. getIcon($participant-&gt;icon, genderize($participant-&gt;explanation));</span>
<a name="l00207"></a>00207 <span class="stringliteral"></span>
<a name="l00208"></a>00208 <span class="stringliteral">                $class = alternate(&#39;</span>even<span class="stringliteral">&#39;, &#39;</span>odd<span class="stringliteral">&#39;);</span>
<a name="l00209"></a>00209 <span class="stringliteral"></span>
<a name="l00210"></a>00210 <span class="stringliteral">                echo &quot;&lt;tr class=&#39;</span>$class<span class="stringliteral">&#39;&gt;&quot;;</span>
<a name="l00211"></a>00211 <span class="stringliteral">                foreach ($columns as $c)</span>
<a name="l00212"></a>00212 <span class="stringliteral">                        echo &quot;&lt;td&gt;${row[$c]}&lt;/td&gt;&quot;;</span>
<a name="l00213"></a>00213 <span class="stringliteral">                echo &quot;&lt;/tr&gt;&quot;;</span>
<a name="l00214"></a>00214 <span class="stringliteral">        }</span>
<a name="l00215"></a>00215 <span class="stringliteral">        echo &quot;&lt;/tbody&gt;&lt;/table&gt;&quot;;</span>
<a name="l00216"></a>00216 <span class="stringliteral">}</span>
<a name="l00217"></a>00217 <span class="stringliteral"></span>
<a name="l00222"></a><a class="code" href="workshop_8php.html#a02e8f38b818a3b8abd93a56b25d0ede6">00222</a> <span class="stringliteral">function getLecturers($wid)</span>
<a name="l00223"></a>00223 <span class="stringliteral">{</span>
<a name="l00224"></a>00224 <span class="stringliteral">        global $DB;</span>
<a name="l00225"></a>00225 <span class="stringliteral">        $lecturers = $DB-&gt;query(&#39;</span>SELECT uid FROM table_workshop_users WHERE participant=$1 AND wid=$2<span class="stringliteral">&#39;,</span>
<a name="l00226"></a>00226 <span class="stringliteral">                enumParticipantStatus(&#39;</span>lecturer<span class="stringliteral">&#39;)-&gt;id, $wid);</span>
<a name="l00227"></a>00227 <span class="stringliteral">        return $lecturers-&gt;fetch_column();</span>
<a name="l00228"></a>00228 <span class="stringliteral">}</span>
<a name="l00229"></a>00229 <span class="stringliteral"></span>
<a name="l00235"></a><a class="code" href="workshop_8php.html#a1321a650f322d9871877a1228d324c5f">00235</a> <span class="stringliteral">function actionShowWorkshop($wid = null)</span>
<a name="l00236"></a>00236 <span class="stringliteral">{</span>
<a name="l00237"></a>00237 <span class="stringliteral">        global $USER, $DB, $PAGE;</span>
<a name="l00238"></a>00238 <span class="stringliteral">        if (is_null($wid))  throw new KnownException(_(&#39;</span>Workshop not found.<span class="stringliteral">&#39;)); // Handle deprecated links.</span>
<a name="l00239"></a>00239 <span class="stringliteral">        $wid = intval($wid);</span>
<a name="l00240"></a>00240 <span class="stringliteral"></span>
<a name="l00241"></a>00241 <span class="stringliteral">        $data = $DB-&gt;workshops[$wid]-&gt;assoc(&#39;</span>*<span class="stringliteral">&#39;);</span>
<a name="l00242"></a>00242 <span class="stringliteral">        $data[&#39;</span>title<span class="stringliteral">&#39;] = htmlspecialchars($data[&#39;</span>title<span class="stringliteral">&#39;]);</span>
<a name="l00243"></a>00243 <span class="stringliteral">        $data[&#39;</span>type<span class="stringliteral">&#39;] = ucfirst(enumBlockType(intval($data[&#39;</span>type<span class="stringliteral">&#39;]))-&gt;description);</span>
<a name="l00244"></a>00244 <span class="stringliteral">        $data[&#39;</span>description<span class="stringliteral">&#39;] = parseUserHTML($data[&#39;</span>description<span class="stringliteral">&#39;]);</span>
<a name="l00245"></a>00245 <span class="stringliteral"></span>
<a name="l00246"></a>00246 <span class="stringliteral">        $participant = $DB-&gt;workshop_users[array(&#39;</span>wid<span class="stringliteral">&#39;=&gt;$wid, &#39;</span>uid<span class="stringliteral">&#39;=&gt;$USER[&#39;</span>uid<span class="stringliteral">&#39;])]-&gt;get(&#39;</span>participant<span class="stringliteral">&#39;);</span>
<a name="l00247"></a>00247 <span class="stringliteral">        $participant = intval($participant);</span>
<a name="l00248"></a>00248 <span class="stringliteral"></span>
<a name="l00249"></a>00249 <span class="stringliteral">        // Lecturers list.</span>
<a name="l00250"></a>00250 <span class="stringliteral">        $data[&#39;</span>by<span class="stringliteral">&#39;] = array();</span>
<a name="l00251"></a>00251 <span class="stringliteral">        $lecturers = getLecturers($wid);</span>
<a name="l00252"></a>00252 <span class="stringliteral">        $displayEmail = $participant || userCan(&#39;</span>editWorkshop<span class="stringliteral">&#39;, $lecturers);</span>
<a name="l00253"></a>00253 <span class="stringliteral">        foreach ($lecturers as $lecturer)</span>
<a name="l00254"></a>00254 <span class="stringliteral">                $data[&#39;</span>by<span class="stringliteral">&#39;][]= getUserBadge($lecturer, $displayEmail);</span>
<a name="l00255"></a>00255 <span class="stringliteral">        $data[&#39;</span>by<span class="stringliteral">&#39;] =  ngettext(&#39;</span>Lecturer<span class="stringliteral">&#39;, &#39;</span>Lecturers<span class="stringliteral">&#39;, count($data[&#39;</span>by<span class="stringliteral">&#39;])) .&#39;</span>: <span class="stringliteral">&#39;. implode(&#39;</span>, <span class="stringliteral">&#39;, $data[&#39;</span>by<span class="stringliteral">&#39;]);</span>
<a name="l00256"></a>00256 <span class="stringliteral"></span>
<a name="l00257"></a>00257 <span class="stringliteral">        if (!userCan(&#39;</span>showWorkshop<span class="stringliteral">&#39;, $lecturers))  throw new PolicyException();</span>
<a name="l00258"></a>00258 <span class="stringliteral"></span>
<a name="l00259"></a>00259 <span class="stringliteral">        if (empty($data[&#39;</span>link<span class="stringliteral">&#39;]))</span>
<a name="l00260"></a>00260 <span class="stringliteral">                $data[&#39;</span>link<span class="stringliteral">&#39;] = &#39;</span>http:<span class="comment">//warsztatywww.wikidot.com/www&#39;. getOption(&#39;currentEdition&#39;).</span>
<a name="l00261"></a>00261                         <span class="charliteral">&#39;:&#39;</span>. urlencode($data[<span class="stringliteral">&#39;title&#39;</span>]);
<a name="l00262"></a>00262 
<a name="l00263"></a>00263         <span class="comment">// The subjects.</span>
<a name="l00264"></a>00264         $subjects = $DB-&gt;query(<span class="stringliteral">&#39;SELECT subject FROM table_workshop_subjects WHERE wid=$1&#39;</span>, $wid);
<a name="l00265"></a>00265         $data[<span class="stringliteral">&#39;subjects&#39;</span>] = array();
<a name="l00266"></a>00266         <span class="keywordflow">foreach</span> ($subjects as $subject)
<a name="l00267"></a>00267                 $data[<span class="stringliteral">&#39;subjects&#39;</span>][]= enumSubject($subject[<span class="stringliteral">&#39;subject&#39;</span>])-&gt;description;
<a name="l00268"></a>00268         $data[<span class="stringliteral">&#39;subjects&#39;</span>] = implode(<span class="stringliteral">&#39;, &#39;</span>, $data[<span class="stringliteral">&#39;subjects&#39;</span>]);
<a name="l00269"></a>00269 
<a name="l00270"></a>00270         <span class="comment">// Basic info.</span>
<a name="l00271"></a>00271         $PAGE-&gt;title = $data[<span class="stringliteral">&#39;title&#39;</span>];
<a name="l00272"></a>00272         $PAGE-&gt;headerTitle = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00273"></a>00273         $template = <span class="keyword">new</span> <a class="code" href="classSimpleTemplate.html">SimpleTemplate</a>($data);
<a name="l00274"></a>00274         ?&gt;
<a name="l00275"></a>00275                 &lt;span <span class="keyword">class</span>=<span class="stringliteral">&#39;left&#39;</span>&gt;%wid%.&amp;nbsp;&lt;/span&gt;&lt;h2&gt;%title% &lt;div <span class="keyword">class</span>=<span class="stringliteral">&#39;tabs&#39;</span>&gt;
<a name="l00276"></a>00276                         &lt;a <span class="keyword">class</span>=<span class="stringliteral">&#39;selected&#39;</span>&gt;{{description}}&lt;/a&gt;
<a name="l00277"></a>00277                         &lt;a href=<span class="stringliteral">&quot;showWorkshopTasks(%wid%)&quot;</span>&gt;{{signups and tasks}}&lt;/a&gt;
<a name="l00278"></a>00278                 &lt;/div&gt;&lt;/h2&gt;
<a name="l00279"></a>00279                 %type%: %subjects%.&lt;br/&gt;
<a name="l00280"></a>00280                 %by%&lt;br/&gt;
<a name="l00281"></a>00281                 {{Duration}}: %duration% Ã— 1,5 godz.&lt;br/&gt;
<a name="l00282"></a>00282                 &lt;a href=<span class="stringliteral">&quot;%link%&quot;</span>&gt;{{see the description on wikidot}}&lt;/a&gt;&lt;br/&gt;
<a name="l00283"></a>00283                 &lt;br/&gt;
<a name="l00284"></a>00284         &lt;?php
<a name="l00285"></a>00285         echo $template-&gt;finish(<span class="keyword">true</span>);
<a name="l00286"></a>00286 
<a name="l00287"></a>00287         <span class="comment">// The signup/signout button (same as in showWorkshopTasks).</span>
<a name="l00288"></a>00288         <span class="keywordflow">if</span> (enumParticipantStatus($participant)-&gt;inArray(array(<span class="stringliteral">&#39;candidate&#39;</span>, <span class="stringliteral">&#39;autoaccepted&#39;</span>)))
<a name="l00289"></a>00289                 echo <a class="code" href="template_8php.html#a93f1d2b73c6defc9f0af8e7e17b0b47d">getButton</a>(_(<span class="stringliteral">&#39;sign out&#39;</span>), <span class="stringliteral">&quot;resignFromWorkshop($wid)&quot;</span>, <span class="stringliteral">&#39;cart-remove.png&#39;</span>)  .<span class="stringliteral">&#39;&lt;br/&gt;&#39;</span>;
<a name="l00290"></a>00290         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$participant &amp;&amp; <a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;signUpForWorkshop&#39;</span>, $lecturers))
<a name="l00291"></a>00291                 echo <a class="code" href="template_8php.html#a93f1d2b73c6defc9f0af8e7e17b0b47d">getButton</a>(_(<span class="stringliteral">&#39;sign up&#39;</span>), <span class="stringliteral">&quot;signUpForWorkshop($wid)&quot;</span>, <span class="stringliteral">&#39;cart-put.png&#39;</span>) .<span class="stringliteral">&#39;&lt;br/&gt;&#39;</span>;
<a name="l00292"></a>00292         echo <span class="stringliteral">&#39;&lt;br/&gt;&#39;</span>;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294         <span class="comment">// Proposition description.</span>
<a name="l00295"></a>00295         <span class="keywordflow">if</span> (<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;showWorkshopDetails&#39;</span>, $lecturers)) {
<a name="l00296"></a>00296                 echo _(<span class="stringliteral">&#39;Proposal&#39;</span>).<span class="stringliteral">&#39;: &lt;div class=&quot;descriptionBox&quot;&gt;&#39;</span>. $data[<span class="stringliteral">&#39;description&#39;</span>] .<span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l00297"></a>00297         }
<a name="l00298"></a>00298         <span class="comment">// Workshop block status (e.g. accepted or not).</span>
<a name="l00299"></a>00299         <span class="keywordflow">if</span> (<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;changeWorkshopStatus&#39;</span>, $lecturers))
<a name="l00300"></a>00300         {
<a name="l00301"></a>00301                 echo _(<span class="stringliteral">&#39;Status:&#39;</span>);
<a name="l00302"></a>00302                 $inputs = <a class="code" href="utils_8php.html#ae70693a7d9a8484219fe57bdf2d2a46f">parseTable</a>(<span class="stringliteral">&#39;</span>
<a name="l00303"></a>00303 <span class="stringliteral">                        NAME   =&gt; TYPE;   tDESCRIPTION;</span>
<a name="l00304"></a>00304 <span class="stringliteral">                        status =&gt; select; ;</span>
<a name="l00305"></a>00305 <span class="stringliteral">                &#39;</span>);
<a name="l00306"></a>00306                 $inputs[<span class="stringliteral">&#39;status&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>] = enumBlockStatus()-&gt;assoc(<span class="stringliteral">&#39;key&#39;</span>, <span class="stringliteral">&#39;decision&#39;</span>);
<a name="l00307"></a>00307                 $form = <span class="keyword">new</span> <a class="code" href="classForm.html">Form</a>($inputs);
<a name="l00308"></a>00308                 <span class="keywordflow">if</span> ($form-&gt;submitted())
<a name="l00309"></a>00309                 {
<a name="l00310"></a>00310                         $values = $form-&gt;fetchAndValidateValues();
<a name="l00311"></a>00311                         <span class="keywordflow">if</span> ($form-&gt;valid)
<a name="l00312"></a>00312                         {
<a name="l00313"></a>00313                                 $status = enumBlockStatus($values[<span class="stringliteral">&#39;status&#39;</span>])-&gt;id;
<a name="l00314"></a>00314                                 $DB-&gt;workshops[$wid]-&gt;update(array(<span class="stringliteral">&#39;status&#39;</span> =&gt; $status));
<a name="l00315"></a>00315                                 $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;Changed workshop block status.&#39;</span>));
<a name="l00316"></a>00316                                 <a class="code" href="log_8php.html#a5eaecfade7f5e117c98d7635b2aba95f">logUser</a>(<span class="stringliteral">&#39;workshop status chg&#39;</span>, $wid);
<a name="l00317"></a>00317                         }
<a name="l00318"></a>00318                 }
<a name="l00319"></a>00319                 $form-&gt;values[<span class="stringliteral">&#39;status&#39;</span>] = enumBlockStatus(intval($data[<span class="stringliteral">&#39;status&#39;</span>]))-&gt;key;
<a name="l00320"></a>00320                 echo $form-&gt;getHTML();
<a name="l00321"></a>00321                 echo <span class="stringliteral">&#39;&lt;br/&gt;&#39;</span>;
<a name="l00322"></a>00322         }
<a name="l00323"></a>00323         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;showWorkshopDetails&#39;</span>, $lecturers)) {
<a name="l00324"></a>00324                  echo _(<span class="stringliteral">&#39;Status:&#39;</span>) .<span class="charliteral">&#39; &#39;</span>. enumBlockStatus($data[<span class="stringliteral">&#39;status&#39;</span>])-&gt;status .<span class="stringliteral">&#39;&lt;br/&gt;&lt;br/&gt;&#39;</span>;
<a name="l00325"></a>00325         }
<a name="l00326"></a>00326         <span class="comment">// Edit-workshop button.</span>
<a name="l00327"></a>00327         <span class="keywordflow">if</span> (<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;editWorkshop&#39;</span>, $lecturers))
<a name="l00328"></a>00328                 echo <a class="code" href="template_8php.html#a93f1d2b73c6defc9f0af8e7e17b0b47d">getButton</a>(_(<span class="stringliteral">&#39;edit&#39;</span>), <span class="stringliteral">&quot;editWorkshop($wid)&quot;</span>, <span class="stringliteral">&#39;brick-edit.png&#39;</span>);
<a name="l00329"></a>00329 }
<a name="l00330"></a>00330 
<a name="l00331"></a><a class="code" href="workshop_8php.html#a7479c454e1290d452aad78ca5d52fef9">00331</a> function <a class="code" href="workshop_8php.html#a7479c454e1290d452aad78ca5d52fef9">actionShowWorkshopTasks</a>($wid)
<a name="l00332"></a>00332 {
<a name="l00333"></a>00333         global $USER, <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>, <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>;
<a name="l00334"></a>00334         $wid = intval($wid);
<a name="l00335"></a>00335 
<a name="l00336"></a>00336         $data = $DB-&gt;workshops[$wid]-&gt;assoc(<span class="charliteral">&#39;*&#39;</span>);
<a name="l00337"></a>00337         $data[<span class="stringliteral">&#39;title&#39;</span>] = htmlspecialchars($data[<span class="stringliteral">&#39;title&#39;</span>]);
<a name="l00338"></a>00338         $data[<span class="stringliteral">&#39;type&#39;</span>] = ucfirst(enumBlockType(intval($data[<span class="stringliteral">&#39;type&#39;</span>]))-&gt;description);
<a name="l00339"></a>00339         $data[<span class="stringliteral">&#39;description&#39;</span>] = <a class="code" href="template_8php.html#a4a7e99592a2690b33d53c9bcc8fd3008">parseUserHTML</a>($data[<span class="stringliteral">&#39;description&#39;</span>]);
<a name="l00340"></a>00340         $lecturers = <a class="code" href="workshop_8php.html#a02e8f38b818a3b8abd93a56b25d0ede6">getLecturers</a>($wid);
<a name="l00341"></a>00341         $participant = $DB-&gt;workshop_users[array(<span class="stringliteral">&#39;wid&#39;</span>=&gt;$wid, <span class="stringliteral">&#39;uid&#39;</span>=&gt;$USER[<span class="stringliteral">&#39;uid&#39;</span>])]-&gt;get(<span class="stringliteral">&#39;participant&#39;</span>);
<a name="l00342"></a>00342         $participant = intval($participant);
<a name="l00343"></a>00343 
<a name="l00344"></a>00344         $PAGE-&gt;title = $data[<span class="stringliteral">&#39;title&#39;</span>] .<span class="stringliteral">&#39; - &#39;</span>. _(<span class="stringliteral">&#39;signups and tasks&#39;</span>);
<a name="l00345"></a>00345         $PAGE-&gt;headerTitle = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00346"></a>00346         $template = <span class="keyword">new</span> <a class="code" href="classSimpleTemplate.html">SimpleTemplate</a>($data);
<a name="l00347"></a>00347         ?&gt;
<a name="l00348"></a>00348                 &lt;span <span class="keyword">class</span>=<span class="stringliteral">&#39;left&#39;</span>&gt;%wid%.&amp;nbsp;&lt;/span&gt;&lt;h2&gt;%title% &lt;div <span class="keyword">class</span>=<span class="stringliteral">&#39;tabs&#39;</span>&gt;
<a name="l00349"></a>00349                         &lt;a href=<span class="stringliteral">&#39;showWorkshop(%wid%)&#39;</span>&gt;{{description}}&lt;/a&gt;
<a name="l00350"></a>00350                         &lt;a <span class="keyword">class</span>=<span class="stringliteral">&#39;selected&#39;</span>&gt;{{signups and tasks}}&lt;/a&gt;
<a name="l00351"></a>00351                 &lt;/div&gt;&lt;/h2&gt;
<a name="l00352"></a>00352         &lt;?php
<a name="l00353"></a>00353         echo $template-&gt;finish(<span class="keyword">true</span>);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355         echo _(<span class="stringliteral">&#39;Your status:&#39;</span>) .<span class="stringliteral">&#39; &lt;i&gt;&#39;</span>. <a class="code" href="user_2utils_8php.html#a7144fa5a413ad5690425b7b720aeedba">genderize</a>(enumParticipantStatus($participant)-&gt;explanation) .<span class="stringliteral">&#39;&lt;/i&gt;&lt;br/&gt;&#39;</span>;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357         <span class="comment">// The signup/signout button (same as in showWorkshop).</span>
<a name="l00358"></a>00358         <span class="keywordflow">if</span> (enumParticipantStatus($participant)-&gt;inArray(array(<span class="stringliteral">&#39;candidate&#39;</span>, <span class="stringliteral">&#39;autoaccepted&#39;</span>)))
<a name="l00359"></a>00359                 echo <a class="code" href="template_8php.html#a93f1d2b73c6defc9f0af8e7e17b0b47d">getButton</a>(_(<span class="stringliteral">&#39;sign out&#39;</span>), <span class="stringliteral">&quot;resignFromWorkshop($wid)&quot;</span>, <span class="stringliteral">&#39;cart-remove.png&#39;</span>)  .<span class="stringliteral">&#39;&lt;br/&gt;&#39;</span>;
<a name="l00360"></a>00360         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!$participant &amp;&amp; <a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;signUpForWorkshop&#39;</span>, $lecturers))
<a name="l00361"></a>00361                 echo <a class="code" href="template_8php.html#a93f1d2b73c6defc9f0af8e7e17b0b47d">getButton</a>(_(<span class="stringliteral">&#39;sign up&#39;</span>), <span class="stringliteral">&quot;signUpForWorkshop($wid)&quot;</span>, <span class="stringliteral">&#39;cart-put.png&#39;</span>) .<span class="stringliteral">&#39;&lt;br/&gt;&#39;</span>;
<a name="l00362"></a>00362         echo <span class="stringliteral">&#39;&lt;br/&gt;&#39;</span>;
<a name="l00363"></a>00363 
<a name="l00364"></a>00364         <span class="comment">// List of signed-up participants.</span>
<a name="l00365"></a>00365         <span class="keywordflow">if</span> (<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;showWorkshopParticipants&#39;</span>, $lecturers))
<a name="l00366"></a>00366                 echo <a class="code" href="tasks_8php.html#ae1f5d73a5ddf78d15aa18706f9786b14">buildParticipantList</a>($wid) . <span class="stringliteral">&#39;&lt;br/&gt;&#39;</span>;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368         <span class="comment">// List of qualification tasks.</span>
<a name="l00369"></a>00369         echo <a class="code" href="tasks_8php.html#a5330df836d593c05befda9913a6acc23">buildTaskList</a>($wid);
<a name="l00370"></a>00370 }
<a name="l00371"></a>00371 
<a name="l00372"></a><a class="code" href="workshop_8php.html#a63ff3f7f5188439e639edd7021f90e70">00372</a> function <a class="code" href="workshop_8php.html#a63ff3f7f5188439e639edd7021f90e70">actionCreateWorkshop</a>()
<a name="l00373"></a>00373 {
<a name="l00374"></a>00374         <a class="code" href="workshop_8php.html#a086c665030f2f28ca42fe178f9832b0f">actionEditWorkshop</a>(-1);
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 
<a name="l00377"></a><a class="code" href="workshop_8php.html#a086c665030f2f28ca42fe178f9832b0f">00377</a> function <a class="code" href="workshop_8php.html#a086c665030f2f28ca42fe178f9832b0f">actionEditWorkshop</a>($wid)
<a name="l00378"></a>00378 {
<a name="l00379"></a>00379         <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a5bbc4a39c360e15b0c00714f18d2082b">assertProfileFilled</a>())  <span class="keywordflow">return</span>;
<a name="l00380"></a>00380         global $USER, <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>, <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>;
<a name="l00381"></a>00381         $wid = intval($wid);
<a name="l00382"></a>00382         $new = ($wid == -1);
<a name="l00383"></a>00383         <span class="keywordflow">if</span> ($new)
<a name="l00384"></a>00384         {
<a name="l00385"></a>00385                 <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;createWorkshop&#39;</span>))  <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classPolicyException.html">PolicyException</a>();
<a name="l00386"></a>00386         }
<a name="l00387"></a>00387         <span class="keywordflow">else</span>
<a name="l00388"></a>00388                 <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;editWorkshop&#39;</span>, <a class="code" href="workshop_8php.html#a02e8f38b818a3b8abd93a56b25d0ede6">getLecturers</a>($wid)))  <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classPolicyException.html">PolicyException</a>();
<a name="l00389"></a>00389 
<a name="l00390"></a>00390         $inputs = <a class="code" href="utils_8php.html#ae70693a7d9a8484219fe57bdf2d2a46f">parseTable</a>(<span class="stringliteral">&#39;</span>
<a name="l00391"></a>00391 <span class="stringliteral">                NAME        =&gt; TYPE;          tDESCRIPTION;                   VALIDATION;</span>
<a name="l00392"></a>00392 <span class="stringliteral">                title       =&gt; text;          Title;                          length(5 100);</span>
<a name="l00393"></a>00393 <span class="stringliteral">                lecturers   =&gt; readonly;      Lecturers;</span>
<a name="l00394"></a>00394 <span class="stringliteral">                description =&gt; richtextarea;  Description;</span>
<a name="l00395"></a>00395 <span class="stringliteral">                subjects    =&gt; checkboxgroup; Subject;</span>
<a name="l00396"></a>00396 <span class="stringliteral">                type        =&gt; select;        Type;</span>
<a name="l00397"></a>00397 <span class="stringliteral">                duration    =&gt; select;        Duration;                       int;             other;</span>
<a name="l00398"></a>00398 <span class="stringliteral">                link        =&gt; text;          Link to description on wikidot;</span>
<a name="l00399"></a>00399 <span class="stringliteral">        &#39;</span>);
<a name="l00400"></a>00400 
<a name="l00401"></a>00401         <span class="keywordflow">if</span> (!$new)
<a name="l00402"></a>00402                 $inputs[<span class="stringliteral">&#39;lecturers&#39;</span>][<span class="stringliteral">&#39;description&#39;</span>] .= <span class="stringliteral">&quot; &lt;a href=&#39;editWorkshopLecturers($wid)&#39;&gt;[&quot;</span>. _(<span class="stringliteral">&#39;change&#39;</span>) .<span class="stringliteral">&quot;]&lt;/a&gt;&quot;</span>;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404         $inputs[<span class="stringliteral">&#39;description&#39;</span>][<span class="stringliteral">&#39;description&#39;</span>] .= <span class="stringliteral">&#39;&lt;br/&gt;&lt;small&gt;&#39;</span>.
<a name="l00405"></a>00405                 _(<span class="stringliteral">&#39;Topics addressed, difficulty, scope of material, &#39;</span>.
<a name="l00406"></a>00406                   <span class="stringliteral">&#39;what will you do (theoretical problems, coding, experiments, ...). &#39;</span>.
<a name="l00407"></a>00407                   <span class="stringliteral">&#39;We encourage possibly detailed descriptions.&#39;</span>)
<a name="l00408"></a>00408                 .<span class="stringliteral">&#39;&lt;/small&gt;&#39;</span>;
<a name="l00409"></a>00409 
<a name="l00410"></a>00410         $inputs[<span class="stringliteral">&#39;subjects&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>] = enumSubject()-&gt;assoc(<span class="stringliteral">&#39;key&#39;</span>, <span class="stringliteral">&#39;description&#39;</span>);
<a name="l00411"></a>00411         $inputs[<span class="stringliteral">&#39;type&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>] = enumBlockType()-&gt;assoc(<span class="stringliteral">&#39;key&#39;</span>,<span class="stringliteral">&#39;description&#39;</span>);
<a name="l00412"></a>00412 
<a name="l00413"></a>00413         $inputs[<span class="stringliteral">&#39;type&#39;</span>][<span class="stringliteral">&#39;properties&#39;</span>] = <span class="stringliteral">&#39;onchange=&quot;$(\&#39;#row_duration\&#39;).toggle(this.selectedIndex==&#39;</span>. enumBlockType(<span class="stringliteral">&#39;workshop&#39;</span>)-&gt;id .<span class="stringliteral">&#39;);&quot;&#39;</span>;
<a name="l00414"></a>00414         $inputs[<span class="stringliteral">&#39;duration&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>] = array(6=&gt;<span class="stringliteral">&#39;9h (6x1.5h)&#39;</span>, 9=&gt;<span class="stringliteral">&#39;13.5h (9x1.5h)&#39;</span>);
<a name="l00415"></a>00415         $inputs[<span class="stringliteral">&#39;duration&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>] = <span class="stringliteral">&#39;[x1,5h]&lt;span class=&quot;left&quot;&gt;(&#39;</span>.
<a name="l00416"></a>00416                 _(<span class="stringliteral">&#39;non-standard durations should be&lt;br/&gt; consulted with the organizers.&#39;</span>)
<a name="l00417"></a>00417                  .<span class="stringliteral">&#39;)&lt;/span&gt;&#39;</span>;
<a name="l00418"></a>00418 
<a name="l00419"></a>00419 
<a name="l00420"></a>00420         $PAGE-&gt;title = $new ? _(<span class="stringliteral">&#39;Propose a new workshop block&#39;</span>) : _(<span class="stringliteral">&#39;Edit a workshop block&#39;</span>);
<a name="l00421"></a>00421         <span class="keywordflow">if</span> (!$new)
<a name="l00422"></a>00422                 echo <span class="stringliteral">&quot;&lt;a class=&#39;back&#39; href=&#39;showWorkshop($wid)&#39;&gt;&quot;</span>. _(<span class="stringliteral">&#39;view&#39;</span>) .<span class="stringliteral">&quot;&lt;/a&gt;&quot;</span>;
<a name="l00423"></a>00423         $form = <span class="keyword">new</span> <a class="code" href="classForm.html">Form</a>($inputs);
<a name="l00424"></a>00424 
<a name="l00425"></a>00425         <span class="keywordflow">if</span> ($form-&gt;submitted())
<a name="l00426"></a>00426         {
<a name="l00427"></a>00427                 $values = $form-&gt;fetchAndValidateValues();
<a name="l00428"></a>00428                 <span class="keywordflow">if</span> ($form-&gt;valid)
<a name="l00429"></a>00429                         <a class="code" href="workshop_8php.html#a4adc68c4f659a8c493ebaa390fdb4a97">submitEditWorkshopForm</a>($wid, $values);
<a name="l00430"></a>00430         }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432         <span class="keywordflow">if</span> ($new)
<a name="l00433"></a>00433         {
<a name="l00434"></a>00434                 $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;The deadline for workshop proposal submissions has expired. Fill the form at your own risk.&#39;</span>), <span class="stringliteral">&#39;warning&#39;</span>);
<a name="l00435"></a>00435 
<a name="l00436"></a>00436                 $data = array(
<a name="l00437"></a>00437                         <span class="stringliteral">&#39;wid&#39;</span> =&gt; -1,
<a name="l00438"></a>00438                         <span class="stringliteral">&#39;title&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00439"></a>00439                         <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00440"></a>00440                         <span class="stringliteral">&#39;status&#39;</span> =&gt; <span class="stringliteral">&#39;new&#39;</span>,
<a name="l00441"></a>00441                         <span class="stringliteral">&#39;materials&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00442"></a>00442                         <span class="stringliteral">&#39;subjects&#39;</span> =&gt; array(),
<a name="l00443"></a>00443                         <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;workshop&#39;</span>,
<a name="l00444"></a>00444                         <span class="stringliteral">&#39;duration&#39;</span> =&gt; 3*2, <span class="comment">//3*2*90min = 9h</span>
<a name="l00445"></a>00445                         <span class="stringliteral">&#39;duration_min&#39;</span> =&gt; 90,
<a name="l00446"></a>00446                         <span class="stringliteral">&#39;link&#39;</span> =&gt; <span class="stringliteral">&#39;http://warsztatywww.wikidot.com/www&#39;</span>. <a class="code" href="utils_8php.html#a86acce3c002ca1af709fd1b04f2f82fa">getOption</a>(<span class="stringliteral">&#39;currentEdition&#39;</span>) .<span class="stringliteral">&#39;:tytul-warsztatow&#39;</span>
<a name="l00447"></a>00447                 );
<a name="l00448"></a>00448                 $lecturers = array($USER[<span class="stringliteral">&#39;uid&#39;</span>]);
<a name="l00449"></a>00449         }
<a name="l00450"></a>00450         <span class="keywordflow">else</span>
<a name="l00451"></a>00451         {
<a name="l00452"></a>00452                 $data = $DB-&gt;workshops[$wid]-&gt;assoc(<span class="charliteral">&#39;*&#39;</span>);
<a name="l00453"></a>00453                 $lecturers = <a class="code" href="workshop_8php.html#a02e8f38b818a3b8abd93a56b25d0ede6">getLecturers</a>($wid);
<a name="l00454"></a>00454                 $data[<span class="stringliteral">&#39;type&#39;</span>] = enumBlockType(intval($data[<span class="stringliteral">&#39;type&#39;</span>]))-&gt;key;
<a name="l00455"></a>00455                 $DB-&gt;query(<span class="stringliteral">&#39;SELECT subject FROM table_workshop_subjects WHERE wid=$1&#39;</span>, $wid);
<a name="l00456"></a>00456                 $data[<span class="stringliteral">&#39;subjects&#39;</span>] = $DB-&gt;fetch_column();
<a name="l00457"></a>00457         }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459         <span class="keywordflow">foreach</span> ($lecturers as $lecturer)
<a name="l00460"></a>00460                 $data[<span class="stringliteral">&#39;lecturers&#39;</span>][]= <a class="code" href="user_2utils_8php.html#a29f037f468ee2716970ae6e7293644e2">getUserBadge</a>($lecturer, <span class="keyword">true</span>);
<a name="l00461"></a>00461         $data[<span class="stringliteral">&#39;lecturers&#39;</span>] =  implode(<span class="stringliteral">&#39;, &#39;</span>, $data[<span class="stringliteral">&#39;lecturers&#39;</span>]);
<a name="l00462"></a>00462         <span class="keywordflow">if</span> ($new)
<a name="l00463"></a>00463                 $data[<span class="stringliteral">&#39;lecturers&#39;</span>] .= <span class="stringliteral">&#39; &lt;small class=&quot;right&quot;&gt;&#39;</span>.
<a name="l00464"></a>00464                         _(<span class="stringliteral">&#39;You\&#39;ll be able to add more lecturers later, by editing this workshop block.&#39;</span>).
<a name="l00465"></a>00465                         <span class="stringliteral">&#39;&lt;/small&gt;&#39;</span>;
<a name="l00466"></a>00466 
<a name="l00467"></a>00467         $form-&gt;values = $data;
<a name="l00468"></a>00468         echo $form-&gt;getHTML();
<a name="l00469"></a>00469 
<a name="l00470"></a>00470         <span class="keywordflow">if</span> ($data[<span class="stringliteral">&#39;type&#39;</span>] != <span class="stringliteral">&#39;workshop&#39;</span>)
<a name="l00471"></a>00471         {
<a name="l00472"></a>00472                 $PAGE-&gt;jsOnLoad .= <span class="stringliteral">&#39;$(&quot;#row_duration&quot;).hide();&#39;</span>;
<a name="l00473"></a>00473                 $PAGE-&gt;jsOnLoad .= <span class="stringliteral">&#39;$(&quot;#row_duration_other&quot;).hide();&#39;</span>;
<a name="l00474"></a>00474         }
<a name="l00475"></a>00475         <span class="keywordflow">if</span> (in_array($data[<span class="stringliteral">&#39;duration&#39;</span>], array_keys($inputs[<span class="stringliteral">&#39;duration&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>])))
<a name="l00476"></a>00476                 $PAGE-&gt;jsOnLoad .= <span class="stringliteral">&#39;$(&quot;#row_duration_other&quot;).hide();&#39;</span>;
<a name="l00477"></a>00477 }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479 
<a name="l00480"></a><a class="code" href="workshop_8php.html#a4adc68c4f659a8c493ebaa390fdb4a97">00480</a> function <a class="code" href="workshop_8php.html#a4adc68c4f659a8c493ebaa390fdb4a97">submitEditWorkshopForm</a>($wid, $values)
<a name="l00481"></a>00481 {
<a name="l00482"></a>00482         global $USER, <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>, <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>;
<a name="l00483"></a>00483         $new = ($wid==-1);
<a name="l00484"></a>00484 
<a name="l00485"></a>00485         $data = array(
<a name="l00486"></a>00486                 <span class="stringliteral">&#39;title&#39;</span> =&gt; $values[<span class="stringliteral">&#39;title&#39;</span>],
<a name="l00487"></a>00487                 <span class="stringliteral">&#39;description&#39;</span> =&gt; $values[<span class="stringliteral">&#39;description&#39;</span>],
<a name="l00488"></a>00488                 <span class="stringliteral">&#39;type&#39;</span> =&gt; enumBlockType($values[<span class="stringliteral">&#39;type&#39;</span>])-&gt;<span class="keywordtype">id</span>,
<a name="l00489"></a>00489                 <span class="stringliteral">&#39;duration&#39;</span> =&gt; ($values[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;lightLecture&#39;</span>) ? 1 : intval($values[<span class="stringliteral">&#39;duration&#39;</span>]),
<a name="l00490"></a>00490                 <span class="stringliteral">&#39;link&#39;</span> =&gt; trim($values[<span class="stringliteral">&#39;link&#39;</span>]),
<a name="l00491"></a>00491                 <span class="stringliteral">&#39;subjects_order&#39;</span> =&gt; empty($_POST[<span class="stringliteral">&#39;subjects&#39;</span>]) ? 0 : <a class="code" href="workshop_8php.html#ae8c3b8a730d8fb94ef2ca3af1e8582a4">subjectOrder</a>($_POST[<span class="stringliteral">&#39;subjects&#39;</span>])
<a name="l00492"></a>00492         );
<a name="l00493"></a>00493 
<a name="l00494"></a>00494         <span class="keywordflow">if</span> (empty($data[<span class="stringliteral">&#39;link&#39;</span>]))  $data[<span class="stringliteral">&#39;link&#39;</span>] = null;
<a name="l00495"></a>00495         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strpos($data[<span class="stringliteral">&#39;link&#39;</span>], <span class="stringliteral">&#39;http://&#39;</span>) !== 0  &amp;&amp;  strpos($data[<span class="stringliteral">&#39;link&#39;</span>], <span class="stringliteral">&#39;https://&#39;</span>) !== 0)
<a name="l00496"></a>00496                 $data[<span class="stringliteral">&#39;link&#39;</span>] = <span class="stringliteral">&#39;http://&#39;</span>. $data[<span class="stringliteral">&#39;link&#39;</span>];
<a name="l00497"></a>00497 
<a name="l00498"></a>00498         <span class="keywordflow">if</span> ($new)
<a name="l00499"></a>00499         {
<a name="l00500"></a>00500                 $data = $data + array(
<a name="l00501"></a>00501                         <span class="stringliteral">&#39;edition&#39;</span> =&gt; intval(<a class="code" href="utils_8php.html#a86acce3c002ca1af709fd1b04f2f82fa">getOption</a>(<span class="stringliteral">&#39;currentEdition&#39;</span>)),
<a name="l00502"></a>00502                         <span class="stringliteral">&#39;status&#39;</span> =&gt; enumBlockStatus(<span class="stringliteral">&#39;new&#39;</span>)-&gt;<span class="keywordtype">id</span>
<a name="l00503"></a>00503                 );
<a name="l00504"></a>00504                 $DB-&gt;workshops[] = $data;
<a name="l00505"></a>00505                 $wid = $DB-&gt;workshops-&gt;lastValue();
<a name="l00506"></a>00506                 $DB-&gt;workshop_users[]= array(<span class="stringliteral">&#39;wid&#39;</span>=&gt;$wid, <span class="stringliteral">&#39;uid&#39;</span>=&gt;$USER[<span class="stringliteral">&#39;uid&#39;</span>],
<a name="l00507"></a>00507                         <span class="stringliteral">&#39;participant&#39;</span>=&gt;enumParticipantStatus(<span class="stringliteral">&#39;lecturer&#39;</span>)-&gt;<span class="keywordtype">id</span>);
<a name="l00508"></a>00508                 <span class="keywordflow">if</span> (!empty($_POST[<span class="stringliteral">&#39;subjects&#39;</span>]))
<a name="l00509"></a>00509                         <span class="keywordflow">foreach</span> ($_POST[<span class="stringliteral">&#39;subjects&#39;</span>] as $d)
<a name="l00510"></a>00510                                 $DB-&gt;workshop_subject[]= array(<span class="stringliteral">&#39;wid&#39;</span>=&gt;$wid, <span class="stringliteral">&#39;subject&#39;</span>=&gt;$d);
<a name="l00511"></a>00511                 $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;Your proposal has been submitted.&#39;</span>), <span class="stringliteral">&#39;success&#39;</span>);
<a name="l00512"></a>00512                 <a class="code" href="log_8php.html#a5eaecfade7f5e117c98d7635b2aba95f">logUser</a>(<span class="stringliteral">&#39;workshop new&#39;</span>, $wid);
<a name="l00513"></a>00513         }
<a name="l00514"></a>00514         <span class="keywordflow">else</span>
<a name="l00515"></a>00515         {
<a name="l00516"></a>00516                 $DB-&gt;workshops[$wid]-&gt;update($data);
<a name="l00517"></a>00517                 $DB-&gt;query(<span class="stringliteral">&#39;DELETE FROM table_workshop_subjects WHERE wid=$1&#39;</span>, $wid);
<a name="l00518"></a>00518                 <span class="keywordflow">if</span> (!empty($_POST[<span class="stringliteral">&#39;subjects&#39;</span>]))
<a name="l00519"></a>00519                         <span class="keywordflow">foreach</span> ($_POST[<span class="stringliteral">&#39;subjects&#39;</span>] as $d)
<a name="l00520"></a>00520                                 $DB-&gt;workshop_subjects[]= array(<span class="stringliteral">&#39;wid&#39;</span>=&gt;$wid, <span class="stringliteral">&#39;subject&#39;</span>=&gt;$d);
<a name="l00521"></a>00521                 $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;Saved.&#39;</span>), <span class="stringliteral">&#39;success&#39;</span>);
<a name="l00522"></a>00522                 <a class="code" href="log_8php.html#a5eaecfade7f5e117c98d7635b2aba95f">logUser</a>(<span class="stringliteral">&#39;workshop edit&#39;</span>, $wid);
<a name="l00523"></a>00523         }
<a name="l00524"></a>00524 }
<a name="l00525"></a>00525 
<a name="l00526"></a><a class="code" href="workshop_8php.html#a38fddb96cb8474ef70b6c580aee4397f">00526</a> function <a class="code" href="workshop_8php.html#a38fddb96cb8474ef70b6c580aee4397f">actionEditWorkshopLecturers</a>($wid)
<a name="l00527"></a>00527 {
<a name="l00528"></a>00528         global $USER, <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>, <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>;
<a name="l00529"></a>00529         $wid = intval($wid);
<a name="l00530"></a>00530         $lecturers = <a class="code" href="workshop_8php.html#a02e8f38b818a3b8abd93a56b25d0ede6">getLecturers</a>($wid);
<a name="l00531"></a>00531         <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;editWorkshop&#39;</span>, $lecturers))  <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classPolicyException.html">PolicyException</a>();
<a name="l00532"></a>00532 
<a name="l00533"></a>00533         $inputs = array();
<a name="l00534"></a>00534         <span class="keywordflow">foreach</span> ($lecturers as $lecturer)
<a name="l00535"></a>00535                 $inputs[<span class="stringliteral">&#39;uid&#39;</span>. $lecturer]= array(
<a name="l00536"></a>00536                         <span class="stringliteral">&#39;name&#39;</span> =&gt; <span class="stringliteral">&#39;uid&#39;</span>. $lecturer,
<a name="l00537"></a>00537                         <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;custom&#39;</span>,
<a name="l00538"></a>00538                         <span class="stringliteral">&#39;description&#39;</span> =&gt; <a class="code" href="user_2utils_8php.html#a29f037f468ee2716970ae6e7293644e2">getUserBadge</a>($lecturer, <span class="keyword">true</span>),
<a name="l00539"></a>00539                         <span class="stringliteral">&#39;custom&#39;</span>=&gt;<span class="stringliteral">&quot;&lt;a href=&#39;removeWorkshopLecturer($wid;$lecturer)&#39;&gt;[&quot;</span>. _(<span class="stringliteral">&#39;remove&#39;</span>). <span class="stringliteral">&quot;&lt;/a&gt;&quot;</span>
<a name="l00540"></a>00540                 );
<a name="l00541"></a>00541 
<a name="l00542"></a>00542         $inputs[<span class="stringliteral">&#39;lecturer&#39;</span>]= array(
<a name="l00543"></a>00543                 <span class="stringliteral">&#39;name&#39;</span>=&gt;<span class="stringliteral">&#39;lecturer&#39;</span>,
<a name="l00544"></a>00544                 <span class="stringliteral">&#39;type&#39;</span>=&gt;<span class="stringliteral">&#39;text&#39;</span>,
<a name="l00545"></a>00545                 <span class="stringliteral">&#39;description&#39;</span> =&gt; _(<span class="stringliteral">&#39;Full name or uid&#39;</span>)
<a name="l00546"></a>00546         );
<a name="l00547"></a>00547         $inputs[<span class="stringliteral">&#39;lecturer&#39;</span>][<span class="stringliteral">&#39;autocomplete&#39;</span>] = $DB-&gt;query(<span class="stringliteral">&#39;</span>
<a name="l00548"></a>00548 <span class="stringliteral">                SELECT name FROM table_users u</span>
<a name="l00549"></a>00549 <span class="stringliteral">                WHERE EXISTS (SELECT * FROM table_edition_users eu</span>
<a name="l00550"></a>00550 <span class="stringliteral">                        WHERE eu.uid=u.uid AND eu.lecturer=1 AND eu.edition=$1)</span>
<a name="l00551"></a>00551 <span class="stringliteral">                ORDER BY name&#39;</span>, <a class="code" href="utils_8php.html#a86acce3c002ca1af709fd1b04f2f82fa">getOption</a>(<span class="stringliteral">&#39;currentEdition&#39;</span>))-&gt;fetch_column();
<a name="l00552"></a>00552 
<a name="l00553"></a>00553         $PAGE-&gt;title = _(<span class="stringliteral">&#39;Add/remove lecturers&#39;</span>);
<a name="l00554"></a>00554         echo <span class="stringliteral">&quot;&lt;a class=&#39;back&#39; href=&#39;editWorkshop($wid)&#39;&gt;&quot;</span>. _(<span class="stringliteral">&#39;back&#39;</span>) .<span class="stringliteral">&quot;&lt;/a&gt;&quot;</span>;
<a name="l00555"></a>00555         echo <span class="stringliteral">&#39;&lt;h3&gt;&#39;</span>. $DB-&gt;workshops($wid)-&gt;get(<span class="stringliteral">&#39;title&#39;</span>) .<span class="stringliteral">&#39;&lt;/h3&gt;&#39;</span>;
<a name="l00556"></a>00556         $form = <span class="keyword">new</span> <a class="code" href="classForm.html">Form</a>($inputs);
<a name="l00557"></a>00557         <span class="keywordflow">if</span> ($form-&gt;submitted())
<a name="l00558"></a>00558         {
<a name="l00559"></a>00559                 $values = $form-&gt;fetchAndValidateValues();
<a name="l00560"></a>00560                 <span class="keywordflow">if</span> ($form-&gt;valid)
<a name="l00561"></a>00561                         <a class="code" href="workshop_8php.html#a44e0748dce9adec0e6363a99f50507e0">actionAddWorkshopLecturer</a>($wid, $values[<span class="stringliteral">&#39;lecturer&#39;</span>]);
<a name="l00562"></a>00562         }
<a name="l00563"></a>00563         $form-&gt;submitValue = _(<span class="stringliteral">&#39;Add&#39;</span>);
<a name="l00564"></a>00564         echo $form-&gt;getHTML();
<a name="l00565"></a>00565 }
<a name="l00566"></a>00566 
<a name="l00567"></a><a class="code" href="workshop_8php.html#aa7552eb71810bd0d694aada5b3e040da">00567</a> function <a class="code" href="workshop_8php.html#aa7552eb71810bd0d694aada5b3e040da">actionRemoveWorkshopLecturer</a>($wid, $uid, $confirm = <span class="keyword">false</span>)
<a name="l00568"></a>00568 {
<a name="l00569"></a>00569         global $USER, <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>, <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>;
<a name="l00570"></a>00570         $wid = intval($wid);
<a name="l00571"></a>00571         $uid = intval($uid);
<a name="l00572"></a>00572         $lecturers = <a class="code" href="workshop_8php.html#a02e8f38b818a3b8abd93a56b25d0ede6">getLecturers</a>($wid);
<a name="l00573"></a>00573         <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;editWorkshop&#39;</span>, $lecturers))  <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classPolicyException.html">PolicyException</a>();
<a name="l00574"></a>00574 
<a name="l00575"></a>00575         <span class="keywordflow">if</span> (!in_array($uid, $lecturers))
<a name="l00576"></a>00576                 $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;The user is not a lecturer.&#39;</span>), <span class="stringliteral">&#39;userError&#39;</span>);
<a name="l00577"></a>00577         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (($uid == $USER[<span class="stringliteral">&#39;uid&#39;</span>]) &amp;&amp; !$confirm)
<a name="l00578"></a>00578         {
<a name="l00579"></a>00579                 $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;Are you sure you want to remove yourself from lecturers?&#39;</span>) .<span class="stringliteral">&#39;&lt;br/&gt;&#39;</span>.
<a name="l00580"></a>00580                         <span class="stringliteral">&quot;&lt;a href=&#39;removeWorkshopLecturer($wid;$uid;1)&#39; class=&#39;button&#39;&gt;&quot;</span>. _(<span class="stringliteral">&#39;yes&#39;</span>). <span class="stringliteral">&quot;&lt;/a&gt; &quot;</span>.
<a name="l00581"></a>00581                         <span class="stringliteral">&quot;&lt;a href=&#39;editWorkshopLecturers($wid)&#39; class=&#39;button&#39;&gt;&quot;</span>. _(<span class="stringliteral">&#39;cancel&#39;</span>). <span class="stringliteral">&quot;&lt;/a&gt;&quot;</span>,
<a name="l00582"></a>00582                         <span class="stringliteral">&#39;warning&#39;</span>);
<a name="l00583"></a>00583         }
<a name="l00584"></a>00584         <span class="keywordflow">else</span>
<a name="l00585"></a>00585         {
<a name="l00586"></a>00586                 $DB-&gt;query(<span class="stringliteral">&#39;DELETE FROM table_workshop_users WHERE wid=$1 AND uid=$2&#39;</span>, $wid, $uid);
<a name="l00587"></a>00587                 $PAGE-&gt;addMessage(<span class="stringliteral">&#39;The user has been removed from lecturers here.&#39;</span>, <span class="stringliteral">&#39;success&#39;</span>);
<a name="l00588"></a>00588         }
<a name="l00589"></a>00589         <a class="code" href="index_8php.html#a6e8525da6dad002542958c13132118e4">callAction</a>(<span class="stringliteral">&#39;editWorkshopLecturers&#39;</span>, array($wid));
<a name="l00590"></a>00590 }
<a name="l00591"></a>00591 
<a name="l00592"></a><a class="code" href="workshop_8php.html#a44e0748dce9adec0e6363a99f50507e0">00592</a> function <a class="code" href="workshop_8php.html#a44e0748dce9adec0e6363a99f50507e0">actionAddWorkshopLecturer</a>($wid, $lecturer, $confirm = <span class="keyword">false</span>)
<a name="l00593"></a>00593 {
<a name="l00594"></a>00594         global $USER, <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>, <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>;
<a name="l00595"></a>00595         $lecturers = <a class="code" href="workshop_8php.html#a02e8f38b818a3b8abd93a56b25d0ede6">getLecturers</a>($wid);
<a name="l00596"></a>00596 
<a name="l00597"></a>00597         <span class="comment">/* Convert textual $lecturer to $uid (a long and boring part). */</span>
<a name="l00598"></a>00598         <span class="keywordflow">if</span> (is_numeric($lecturer))
<a name="l00599"></a>00599         {
<a name="l00600"></a>00600                 $uid = intval($lecturer);
<a name="l00601"></a>00601                 <span class="keywordflow">if</span> (!isset($DB-&gt;users[$uid]))  <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classKnownException.html">KnownException</a>(_(<span class="stringliteral">&#39;User not found.&#39;</span>));
<a name="l00602"></a>00602         }
<a name="l00603"></a>00603         <span class="keywordflow">else</span>
<a name="l00604"></a>00604         {
<a name="l00605"></a>00605                 <span class="comment">// Try to match the name.</span>
<a name="l00606"></a>00606                 $uid = $DB-&gt;query(<span class="stringliteral">&#39;SELECT uid FROM table_users WHERE name=$1&#39;</span>, trim($lecturer))-&gt;fetch();
<a name="l00607"></a>00607                 <span class="keywordflow">if</span> ($uid === null)
<a name="l00608"></a>00608                 {
<a name="l00609"></a>00609                         <span class="comment">// Fuzzy match - find name with least levenshtein distance.</span>
<a name="l00610"></a>00610                         $names = $DB-&gt;query(<span class="stringliteral">&#39;</span>
<a name="l00611"></a>00611 <span class="stringliteral">                                SELECT uid, name FROM table_users u</span>
<a name="l00612"></a>00612 <span class="stringliteral">                                WHERE EXISTS (SELECT * FROM table_edition_users eu</span>
<a name="l00613"></a>00613 <span class="stringliteral">                                        WHERE eu.uid=u.uid AND eu.lecturer=1 AND eu.edition=$1)</span>
<a name="l00614"></a>00614 <span class="stringliteral">                                ORDER BY name&#39;</span>, <a class="code" href="utils_8php.html#a86acce3c002ca1af709fd1b04f2f82fa">getOption</a>(<span class="stringliteral">&#39;currentEdition&#39;</span>))-&gt;fetch_all();
<a name="l00615"></a>00615                         $best = 100000;
<a name="l00616"></a>00616                         $bestname = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00617"></a>00617                         <span class="keywordflow">foreach</span> ($names as $name)
<a name="l00618"></a>00618                                 <span class="keywordflow">if</span> (levenshtein($name[<span class="stringliteral">&#39;name&#39;</span>], $lecturer) &lt; $best)
<a name="l00619"></a>00619                                 {
<a name="l00620"></a>00620                                         $best = levenshtein($name[<span class="stringliteral">&#39;name&#39;</span>], $lecturer);
<a name="l00621"></a>00621                                         $uid = $name[<span class="stringliteral">&#39;uid&#39;</span>];
<a name="l00622"></a>00622                                         $bestname = $name[<span class="stringliteral">&#39;name&#39;</span>];
<a name="l00623"></a>00623                                 }
<a name="l00624"></a>00624                         $PAGE-&gt;addMessage(sprintf(_(<span class="stringliteral">&#39;Fuzzy-matched user #%d&#39;</span>), $uid) .<span class="stringliteral">&quot; &lt;i&gt;$bestname&lt;/i&gt;&quot;</span>, <span class="stringliteral">&#39;info&#39;</span>);
<a name="l00625"></a>00625                 }
<a name="l00626"></a>00626         }
<a name="l00627"></a>00627 
<a name="l00628"></a>00628         <span class="keywordflow">if</span> (in_array($uid, $lecturers))
<a name="l00629"></a>00629                 $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;The user you selected already is a lecturer here.&#39;</span>), <span class="stringliteral">&#39;userError&#39;</span>);
<a name="l00630"></a>00630         <span class="keywordflow">else</span>
<a name="l00631"></a>00631         {
<a name="l00632"></a>00632                 $DB-&gt;query(<span class="stringliteral">&#39;SELECT count(*) FROM table_workshop_users WHERE wid=$1 AND uid=$2&#39;</span>, $wid, $uid);
<a name="l00633"></a>00633                 <span class="keywordflow">if</span> ($DB-&gt;fetch() &amp;&amp; ($confirm === <span class="keyword">false</span>))
<a name="l00634"></a>00634                 {
<a name="l00635"></a>00635                         $PAGE-&gt;addMessage(
<a name="l00636"></a>00636                                 _(<span class="stringliteral">&#39;The user already signed up as a participant. Sign him out and add to lecturers?&#39;</span>) .
<a name="l00637"></a>00637                                 <span class="stringliteral">&#39;&lt;br/&gt;&#39;</span>.
<a name="l00638"></a>00638                                 <span class="stringliteral">&quot;&lt;a href=&#39;addWorkshopLecturer($wid;$uid;1)&#39; class=&#39;button&#39;&gt;&quot;</span>. _(<span class="stringliteral">&#39;yes&#39;</span>) .<span class="stringliteral">&quot;&lt;/a&gt; &quot;</span>.
<a name="l00639"></a>00639                                 <span class="stringliteral">&quot;&lt;a href=&#39;editWorkshopLecturers($wid)&#39; class=&#39;button&#39;&gt;&quot;</span>. _(<span class="stringliteral">&#39;cancel&#39;</span>). <span class="stringliteral">&quot;&lt;/a&gt;&quot;</span>,
<a name="l00640"></a>00640                                 <span class="stringliteral">&#39;warning&#39;</span>);
<a name="l00641"></a>00641                 }
<a name="l00642"></a>00642                 <span class="keywordflow">else</span>
<a name="l00643"></a>00643                 {
<a name="l00644"></a>00644                         <span class="keywordflow">if</span> ($confirm !== <span class="keyword">false</span>)
<a name="l00645"></a>00645                                 $DB-&gt;query(<span class="stringliteral">&#39;DELETE FROM table_workshop_users WHERE wid=$1 AND uid=$2&#39;</span>, $wid, $uid);
<a name="l00646"></a>00646                         $DB-&gt;workshop_users[]= array(<span class="stringliteral">&#39;uid&#39;</span>=&gt;$uid, <span class="stringliteral">&#39;wid&#39;</span>=&gt;$wid,
<a name="l00647"></a>00647                                 <span class="stringliteral">&#39;participant&#39;</span>=&gt;enumParticipantStatus(<span class="stringliteral">&#39;lecturer&#39;</span>)-&gt;<span class="keywordtype">id</span>);
<a name="l00648"></a>00648                         $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;Added user to lecturers.&#39;</span>), <span class="stringliteral">&#39;success&#39;</span>);
<a name="l00649"></a>00649                 }
<a name="l00650"></a>00650         }
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653 
<a name="l00654"></a><a class="code" href="workshop_8php.html#a538a5114f43f9e0ff781829a2ec568b0">00654</a> function <a class="code" href="workshop_8php.html#a538a5114f43f9e0ff781829a2ec568b0">actionSignUpForWorkshop</a>($wid)
<a name="l00655"></a>00655 {
<a name="l00656"></a>00656         global $USER, <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>, <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>;
<a name="l00657"></a>00657         $wid = intval($wid);
<a name="l00658"></a>00658         <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;signUpForWorkshop&#39;</span>))  <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classPolicyException.html">PolicyException</a>();
<a name="l00659"></a>00659 
<a name="l00660"></a>00660         $participant = <span class="stringliteral">&#39;candidate&#39;</span>;
<a name="l00661"></a>00661         <span class="keywordflow">if</span> (<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;autoQualifyForWorkshop&#39;</span>))  $participant = <span class="stringliteral">&#39;autoaccepted&#39;</span>;
<a name="l00662"></a>00662         $participant = enumParticipantStatus($participant)-&gt;id;
<a name="l00663"></a>00663 
<a name="l00664"></a>00664         $dbRow = $DB-&gt;workshop_users[array(<span class="stringliteral">&#39;wid&#39;</span>=&gt;$wid,<span class="stringliteral">&#39;uid&#39;</span>=&gt;$USER[<span class="stringliteral">&#39;uid&#39;</span>])];
<a name="l00665"></a>00665         <span class="keywordflow">if</span> (!$dbRow-&gt;count())
<a name="l00666"></a>00666                 $DB-&gt;workshop_users[] = array(<span class="stringliteral">&#39;wid&#39;</span>=&gt;$wid,<span class="stringliteral">&#39;uid&#39;</span>=&gt;$USER[<span class="stringliteral">&#39;uid&#39;</span>], <span class="stringliteral">&#39;participant&#39;</span>=&gt;$participant);
<a name="l00667"></a>00667         <span class="keywordflow">else</span>
<a name="l00668"></a>00668         {
<a name="l00669"></a>00669                 <span class="keywordflow">if</span> ($dbRow-&gt;get(<span class="stringliteral">&#39;participant&#39;</span>) != enumParticipantStatus(<span class="stringliteral">&#39;none&#39;</span>)-&gt;id)
<a name="l00670"></a>00670                         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classKnownException.html">KnownException</a>(_(<span class="stringliteral">&#39;You\&#39;re already signed up for this workshop block.&#39;</span>));
<a name="l00671"></a>00671                 $dbRow-&gt;update(array(<span class="stringliteral">&#39;participant&#39;</span>=&gt;$participant));
<a name="l00672"></a>00672         }
<a name="l00673"></a>00673 
<a name="l00674"></a>00674         $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;Signed up for a workshop block.&#39;</span>), <span class="stringliteral">&#39;success&#39;</span>);
<a name="l00675"></a>00675         <a class="code" href="index_8php.html#a6e8525da6dad002542958c13132118e4">callAction</a>(<span class="stringliteral">&#39;showWorkshop&#39;</span>, array($wid));
<a name="l00676"></a>00676         <a class="code" href="log_8php.html#a5eaecfade7f5e117c98d7635b2aba95f">logUser</a>(<span class="stringliteral">&#39;workshop participant signup&#39;</span>, $wid);
<a name="l00677"></a>00677 }
<a name="l00678"></a>00678 
<a name="l00679"></a><a class="code" href="workshop_8php.html#a5a0d9cba96e5c17779acedf8d471605a">00679</a> function <a class="code" href="workshop_8php.html#a5a0d9cba96e5c17779acedf8d471605a">actionResignFromWorkshop</a>($wid)
<a name="l00680"></a>00680 {
<a name="l00681"></a>00681         global $USER, <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>, <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>;
<a name="l00682"></a>00682         $wid = intval($wid);
<a name="l00683"></a>00683         $dbRow = $DB-&gt;workshop_users[array(<span class="stringliteral">&#39;wid&#39;</span>=&gt;$wid,<span class="stringliteral">&#39;uid&#39;</span>=&gt;$USER[<span class="stringliteral">&#39;uid&#39;</span>])];
<a name="l00684"></a>00684         $participant = enumParticipantStatus(intval($dbRow-&gt;get(<span class="stringliteral">&#39;participant&#39;</span>)));
<a name="l00685"></a>00685         <span class="keywordflow">if</span> (!$participant-&gt;canResign)
<a name="l00686"></a>00686                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classKnownException.html">KnownException</a>(_(<span class="stringliteral">&#39;Your can\&#39;t resign from your status: &#39;</span>). $participant-&gt;description);
<a name="l00687"></a>00687         $dbRow-&gt;delete();
<a name="l00688"></a>00688         $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;Resigned from workshop block.&#39;</span>), <span class="stringliteral">&#39;success&#39;</span>);
<a name="l00689"></a>00689         <a class="code" href="index_8php.html#a6e8525da6dad002542958c13132118e4">callAction</a>(<span class="stringliteral">&#39;showWorkshop&#39;</span>, array($wid));
<a name="l00690"></a>00690         <a class="code" href="log_8php.html#a5eaecfade7f5e117c98d7635b2aba95f">logUser</a>(<span class="stringliteral">&#39;workshop participant resign&#39;</span>, $wid);
<a name="l00691"></a>00691 }
<a name="l00692"></a>00692 
<a name="l00693"></a><a class="code" href="workshop_8php.html#ae8c3b8a730d8fb94ef2ca3af1e8582a4">00693</a> function <a class="code" href="workshop_8php.html#ae8c3b8a730d8fb94ef2ca3af1e8582a4">subjectOrder</a>($subjects)
<a name="l00694"></a>00694 {
<a name="l00695"></a>00695         $r = 0;
<a name="l00696"></a>00696         <span class="keywordflow">foreach</span> (enumSubject() as $subjectName=&gt;$subject)
<a name="l00697"></a>00697                 <span class="keywordflow">if</span> (in_array($subjectName, $subjects))
<a name="l00698"></a>00698                         $r += $subject-&gt;orderWeight;
<a name="l00699"></a>00699         <span class="keywordflow">return</span> $r;
<a name="l00700"></a>00700 }
<a name="l00701"></a>00701 
<a name="l00702"></a><a class="code" href="workshop_8php.html#a94f343d568c722874d829e163cf0a361">00702</a> function <a class="code" href="workshop_8php.html#a94f343d568c722874d829e163cf0a361">actionRecountSubjectOrder</a>()
<a name="l00703"></a>00703 {
<a name="l00704"></a>00704         global <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>;
<a name="l00705"></a>00705         $wids = $DB-&gt;query(<span class="stringliteral">&#39;SELECT wid FROM table_workshops&#39;</span>)-&gt;fetch_column();
<a name="l00706"></a>00706         <span class="keywordflow">foreach</span> ($wids as $wid)
<a name="l00707"></a>00707         {
<a name="l00708"></a>00708                 $DB-&gt;query(<span class="stringliteral">&#39;SELECT subject FROM table_workshop_subjects WHERE wid=$1&#39;</span>, $wid);
<a name="l00709"></a>00709                 $order = <a class="code" href="workshop_8php.html#ae8c3b8a730d8fb94ef2ca3af1e8582a4">subjectOrder</a>($DB-&gt;fetch_column());
<a name="l00710"></a>00710                 $DB-&gt;workshops[$wid]-&gt;update(array(<span class="stringliteral">&#39;subjects_order&#39;</span>=&gt;$order));
<a name="l00711"></a>00711         }
<a name="l00712"></a>00712 }
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Thu Aug 11 2011 for wwwApp by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
