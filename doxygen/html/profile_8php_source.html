<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>wwwApp: user/profile.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">wwwApp
   </div>
   <div id="projectbrief">A web app for workshop organizing, recruitment and qualification</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_111cd2f11cffd6d6d28d89ee0389ee9e.html">user</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">profile.php</div>  </div>
</div><!--header-->
<div class="contents">
<a href="profile_8php.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&lt;?php</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * user/profile.php</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div>
<div class="line"><a name="l00006"></a><span class="lineno"><a class="code" href="profile_8php.html#a0c599d4d650d9e6be9ff83f387f2a54a">    6</a></span>&#160;<span class="keyword">function</span> <a class="code" href="profile_8php.html#a0c599d4d650d9e6be9ff83f387f2a54a">getAvatarPath</a>($uid = null)</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;{</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;        <span class="keywordflow">if</span> (is_null($uid))</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;                <span class="keywordflow">return</span> <span class="stringliteral">&#39;fineuploader/avatars/&#39;</span>;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;                <span class="keywordflow">return</span> <span class="stringliteral">&#39;fineuploader/avatars/user&#39;</span>. $uid .<span class="stringliteral">&#39;.jpg&#39;</span>;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;}</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">// Unfinished function for showing someone&#39;s profile (to anyone registered).</span></div>
<div class="line"><a name="l00015"></a><span class="lineno"><a class="code" href="profile_8php.html#aff9daec7313da1b26885ec722adb53e2">   15</a></span>&#160;<span class="keyword">function</span> <a class="code" href="profile_8php.html#aff9daec7313da1b26885ec722adb53e2">actionShowProfile</a>($uid = null)</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;{</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        global $USER, <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>, <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;        $currentEdition = <a class="code" href="utils_8php.html#a86acce3c002ca1af709fd1b04f2f82fa">getOption</a>(<span class="stringliteral">&#39;currentEdition&#39;</span>);</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;        $own = is_null($uid) || ($uid == $USER[<span class="stringliteral">&#39;uid&#39;</span>]);</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;        $uid = $own ? $USER[<span class="stringliteral">&#39;uid&#39;</span>] : intval($uid);</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;showProfile&#39;</span>, $uid))  <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classPolicyException.html">PolicyException</a>();</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;        <span class="keywordflow">if</span> (!isset($DB-&gt;users[$uid]))</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;                <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classKnownException.html">KnownException</a>(_(<span class="stringliteral">&#39;User not found.&#39;</span>));</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;        $user = $DB-&gt;users[$uid]-&gt;assoc(<span class="charliteral">&#39;*&#39;</span>);</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;        $gender = $user[<span class="stringliteral">&#39;gender&#39;</span>];</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;        $PAGE-&gt;title = $user[<span class="stringliteral">&#39;name&#39;</span>]. <span class="stringliteral">&#39; - &#39;</span>. _(<span class="stringliteral">&#39;profile&#39;</span>);</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;        $PAGE-&gt;headerTitle = <span class="stringliteral">&#39;&lt;span class=&quot;left&quot;&gt;&#39;</span>. $uid .<span class="stringliteral">&#39;.&amp;nbsp;&lt;/span&gt;&#39;</span>;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;        $PAGE-&gt;headerTitle .= <span class="stringliteral">&#39;&lt;h2&gt;&#39;</span>. $user[<span class="stringliteral">&#39;name&#39;</span>]. <span class="stringliteral">&#39; - &#39;</span>. _(<span class="stringliteral">&#39;profile&#39;</span>) .<span class="stringliteral">&#39;&lt;/h2&gt;&#39;</span>;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;        $avatar = <a class="code" href="profile_8php.html#a0c599d4d650d9e6be9ff83f387f2a54a">getAvatarPath</a>($uid);</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        <span class="keywordflow">if</span> (file_exists($avatar))</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;                $user[<span class="stringliteral">&#39;avatar&#39;</span>] = <span class="stringliteral">&#39;&lt;img class=&quot;avatar&quot; src=&quot;&#39;</span>. $avatar .<span class="charliteral">&#39;?&#39;</span>. filemtime($avatar) .<span class="stringliteral">&#39;&quot; /&gt;&#39;</span>;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;                $user[<span class="stringliteral">&#39;avatar&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;        <span class="comment">//print &#39;&lt;a href=&quot;mailto:&#39;. $user[&#39;name&#39;] .&#39; &lt;&#39;. $user[&#39;email&#39;] .&#39;&gt;&quot;&gt;&#39;. $user[&#39;email&#39;] .&#39;&lt;/a&gt;&lt;br/&gt;&#39;;</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;        $gradOptions = <a class="code" href="profile_8php.html#a6e25cefab90ef44a1ae9cbfb47ad4f22">getGraduationYearOptions</a>(<span class="keyword">true</span>);</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;        <span class="keywordflow">if</span> (isset($gradOptions[$graduation]))</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;                $user[<span class="stringliteral">&#39;graduationyear&#39;</span>] = $gradOptions[$user[<span class="stringliteral">&#39;graduationyear&#39;</span>]];</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;        $user[<span class="stringliteral">&#39;interests&#39;</span>] = <a class="code" href="template_8php.html#a4a7e99592a2690b33d53c9bcc8fd3008">parseUserHTML</a>($user[<span class="stringliteral">&#39;interests&#39;</span>]);</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        $user[<span class="stringliteral">&#39;motivationletter&#39;</span>] = <a class="code" href="template_8php.html#a4a7e99592a2690b33d53c9bcc8fd3008">parseUserHTML</a>($user[<span class="stringliteral">&#39;motivationletter&#39;</span>]);</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;        $user[<span class="stringliteral">&#39;badge&#39;</span>] = <a class="code" href="user_2utils_8php.html#a29f037f468ee2716970ae6e7293644e2">getUserBadge</a>($uid, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;        $user[<span class="stringliteral">&#39;school&#39;</span>] = <a class="code" href="template_8php.html#a4a7e99592a2690b33d53c9bcc8fd3008">parseUserHTML</a>($user[<span class="stringliteral">&#39;school&#39;</span>]);</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;        $template = <span class="keyword">new</span> <a class="code" href="classSimpleTemplate.html">SimpleTemplate</a>($user);</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        ?&gt;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;                &lt;span <span class="keyword">class</span>=<span class="stringliteral">&quot;left&quot;</span>&gt;%badge% (%login%)&lt;/span&gt;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;                &lt;span <span class="keyword">class</span>=<span class="stringliteral">&quot;right&quot;</span>&gt;%school% - ({{graduation year}}: %graduationyear%)&lt;/span&gt;&lt;br/&gt;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;                %avatar%</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;                &lt;h3 onclick=<span class="stringliteral">&#39;$(&quot;#interests_sign&quot;).toggle(); $(&quot;#interests&quot;).toggle(&quot;fast&quot;);&#39;</span> style=<span class="stringliteral">&#39;cursor: pointer&#39;</span>&gt;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;                         &lt;span <span class="keywordtype">id</span>=<span class="stringliteral">&#39;interests_sign&#39;</span>&gt;+&lt;/span&gt; {{Interests}}&lt;/h3&gt;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;                &lt;div <span class="keyword">class</span>=<span class="stringliteral">&quot;descriptionBox&quot;</span> <span class="keywordtype">id</span>=<span class="stringliteral">&quot;interests&quot;</span> style=<span class="stringliteral">&quot;display:none&quot;</span>&gt;%interests%&lt;/div&gt;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        &lt;?php</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;adminUsers&#39;</span>))</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        {</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        ?&gt;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;                &lt;h3 onclick=<span class="stringliteral">&#39;$(&quot;#motivation_sign&quot;).toggle(); $(&quot;#motivation&quot;).toggle(&quot;fast&quot;);&#39;</span> style=<span class="stringliteral">&#39;cursor: pointer&#39;</span>&gt;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;                        &lt;span <span class="keywordtype">id</span>=<span class="stringliteral">&#39;motivation_sign&#39;</span>&gt;+&lt;/span&gt; {{Motivation letter}}&lt;/h3&gt;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;                &lt;div <span class="keyword">class</span>=<span class="stringliteral">&quot;descriptionBox&quot;</span> <span class="keywordtype">id</span>=<span class="stringliteral">&quot;motivation&quot;</span> style=<span class="stringliteral">&quot;display:none&quot;</span>&gt;%motivationletter%&lt;/div&gt;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        &lt;?php</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;                <span class="comment">// TODO show roles, howdoyouknowus</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;                print <span class="stringliteral">&#39;&lt;br/&gt;&#39;</span>;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;                print <a class="code" href="user_2utils_8php.html#a7144fa5a413ad5690425b7b720aeedba">genderize</a>(_(<span class="stringliteral">&#39;registered&#39;</span>), $gender) .<span class="stringliteral">&#39;: &#39;</span>;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;                print <a class="code" href="utils_8php.html#a16f4dfa58e8647af2e848df3623b628c">fixedStrftime</a>(<span class="stringliteral">&#39;%Y-%m-%d %H:%M (%ago%)&#39;</span>, $user[<span class="stringliteral">&#39;registered&#39;</span>]) ;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;                print <span class="stringliteral">&#39;, &amp;nbsp;&#39;</span>;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;                print _(<span class="stringliteral">&#39;last login&#39;</span>) .<span class="stringliteral">&#39;: &#39;</span>;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;                <span class="keywordflow">if</span> ($user[<span class="stringliteral">&#39;confirm&#39;</span>] &gt; 0)</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;                        print _(<span class="stringliteral">&#39;the user hasn\&#39;t confirmed his e-mail yet&#39;</span>);</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($user[<span class="stringliteral">&#39;logged&#39;</span>] == 0)</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;                        print _(<span class="stringliteral">&#39;the user hasn\&#39;t logged in yet&#39;</span>);</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                        print <a class="code" href="utils_8php.html#a16f4dfa58e8647af2e848df3623b628c">fixedStrftime</a>(<span class="stringliteral">&#39;%Y-%m-%d %H:%M (%ago%)&#39;</span>, $user[<span class="stringliteral">&#39;logged&#39;</span>]);</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;                print <span class="stringliteral">&#39;&lt;br/&gt;&#39;</span>;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        }</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        echo $template-&gt;finish(<span class="keyword">true</span>);</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;}</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div>
<div class="line"><a name="l00084"></a><span class="lineno"><a class="code" href="profile_8php.html#a0e394e32f8c12de6f267b12957a3c219">   84</a></span>&#160;<span class="keyword">function</span> <a class="code" href="profile_8php.html#a0e394e32f8c12de6f267b12957a3c219">actionEditProfile</a>($uid = null)</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;{</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        global $USER, <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>, <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        $currentEdition = <a class="code" href="utils_8php.html#a86acce3c002ca1af709fd1b04f2f82fa">getOption</a>(<span class="stringliteral">&#39;currentEdition&#39;</span>);</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        <span class="comment">// Edit my own profile or admin-edit someone other&#39;s profile:</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        $admin = !is_null($uid);</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        <span class="keywordflow">if</span> ($admin)</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        {</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;adminUsers&#39;</span>))  <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classPolicyException.html">PolicyException</a>();</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;                $uid = intval($uid);</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;                <span class="keywordflow">if</span> (!isset($DB-&gt;users[$uid]))</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;                        <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classKnownException.html">KnownException</a>(_(<span class="stringliteral">&#39;User not found.&#39;</span>));</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;                $name = $DB-&gt;users[$uid]-&gt;get(<span class="stringliteral">&#39;name&#39;</span>);</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                $PAGE-&gt;title = $name. <span class="stringliteral">&#39; - &#39;</span>. _(<span class="stringliteral">&#39;profile&#39;</span>);</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;                $PAGE-&gt;headerTitle = <a class="code" href="admin_8php.html#a9cfe349e8c7f62fd2a38c48f80b90028">getUserHeader</a>($uid, $name, <span class="stringliteral">&#39;editProfile&#39;</span>);</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        }</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        {</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                $uid = intval($USER[<span class="stringliteral">&#39;uid&#39;</span>]);</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;                <span class="comment">//if (!userCan(&#39;editProfile&#39;, $uid))  throw new PolicyException();</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;                $admin = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;                $PAGE-&gt;title = _(<span class="stringliteral">&#39;Your profile&#39;</span>);</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        }</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;impersonate&#39;</span>, $uid) &amp;&amp; ($uid != $USER[<span class="stringliteral">&#39;uid&#39;</span>]))</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;                echo <span class="stringliteral">&#39;&lt;a href=&quot;impersonate(&#39;</span>. $uid .<span class="stringliteral">&#39;)/&quot; &#39;</span>.</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;                        <a class="code" href="template_8php.html#a9b9585537fe5238d4d5b54478251ccfa">getTipJS</a>(_(<span class="stringliteral">&#39;Executes everything as if you were logged in as that person.&#39;</span>)) .<span class="charliteral">&#39;&gt;&#39;</span>.</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                        _(<span class="stringliteral">&#39;impersonate&#39;</span>). <span class="stringliteral">&#39;&lt;/a&gt;&#39;</span>;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        $nadmin = $admin ? <span class="stringliteral">&#39;false&#39;</span> : <span class="stringliteral">&#39;true&#39;</span>; <span class="comment">// Non-admins can only read some values.</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        $inputs = <a class="code" href="utils_8php.html#ae70693a7d9a8484219fe57bdf2d2a46f">parseTable</a>(<span class="stringliteral">&quot;</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="stringliteral">                NAME            =&gt; TYPE;          tDESCRIPTION;            bREADONLY; VALIDATION;</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="stringliteral">                registered      =&gt; timestamp;     registered;              true;      ;</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="stringliteral">                logged          =&gt; timestamp;     last login;              true;      ;</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="stringliteral">                avatar          =&gt; custom;        photo;                   true;      ;</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="stringliteral">                name            =&gt; text;          full name;               $nadmin;   charset(name),length(3 70);</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="stringliteral">                login           =&gt; text;          username;                $nadmin;   charset(name digit),length(3 20);</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="stringliteral">                email           =&gt; text;          e-mail;                  $nadmin;   email;</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="stringliteral">                password        =&gt; custom;        password;                true;      ;</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="stringliteral">                gender          =&gt; select;        grammatical gender;      false;     ;</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="stringliteral">                role            =&gt; select;        role in current edition; $nadmin;   ;              notdb;</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="stringliteral">                roles           =&gt; checkboxgroup; other roles;             $nadmin;   ;              notdb;</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="stringliteral">                school          =&gt; text;          school/university;       false;     ;</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="stringliteral">                graduationyear  =&gt; select;        high school graduation year; false; int;           other=&gt;;</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="stringliteral">                howdoyouknowus  =&gt; text;          how do you know us?;     false;     ;</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="stringliteral">                interests       =&gt; richtextarea;  interests;               false;     ;</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="stringliteral">        &quot;</span>);</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        $inputs[<span class="stringliteral">&#39;avatar&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>] = <span class="stringliteral">&#39;&lt;div onclick=\&#39;$(&quot;#avatarSign&quot;).toggle(); $(&quot;#avatarBox&quot;).toggle(&quot;fast&quot;);\&#39; style=&quot;cursor: pointer&quot;&gt;</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="stringliteral">                         &lt;span id=&quot;avatarSign&quot;&gt;+&lt;/span&gt; &#39;</span>. _(<span class="stringliteral">&#39;change&#39;</span>) .<span class="stringliteral">&#39;...&lt;/div&gt;&lt;div id=&quot;avatarBox&quot;&gt;&#39;</span>.</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                         <span class="stringliteral">&#39;&lt;div id=&quot;avatarUpload&quot;&gt;&lt;/div&gt; &lt;img id=&quot;avatar&quot; &#39;</span>;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        $src = <a class="code" href="profile_8php.html#a0c599d4d650d9e6be9ff83f387f2a54a">getAvatarPath</a>($uid);</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        <span class="keywordflow">if</span> (file_exists($src))</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                $inputs[<span class="stringliteral">&#39;avatar&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>] .= <span class="stringliteral">&#39;src=&quot;&#39;</span>. $src .<span class="charliteral">&#39;?&#39;</span>. filemtime($src) .<span class="charliteral">&#39;&quot;&#39;</span>;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        $inputs[<span class="stringliteral">&#39;avatar&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>] .=</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                         <span class="stringliteral">&#39; /&gt; &lt;/div&gt;&#39;</span>;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        $inputs[<span class="stringliteral">&#39;password&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>] = <span class="stringliteral">&#39;&lt;a href=&quot;changePassword&quot;&gt;&#39;</span>. _(<span class="stringliteral">&#39;change&#39;</span>) .<span class="stringliteral">&#39;&lt;/a&gt;&#39;</span>;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="keywordflow">if</span> ($admin)</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                unset($inputs[<span class="stringliteral">&#39;password&#39;</span>]);</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        {</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;                unset($inputs[<span class="stringliteral">&#39;registered&#39;</span>]);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;                unset($inputs[<span class="stringliteral">&#39;logged&#39;</span>]);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        }</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        $inputs[<span class="stringliteral">&#39;gender&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>] = array(<span class="charliteral">&#39;m&#39;</span> =&gt; _(<span class="stringliteral">&#39;masculine&#39;</span>), <span class="charliteral">&#39;f&#39;</span> =&gt; _(<span class="stringliteral">&#39;feminine&#39;</span>));</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        $inputs[<span class="stringliteral">&#39;role&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>] = array(</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;                <span class="stringliteral">&#39;none&#39;</span>=&gt; _(<span class="stringliteral">&#39;None&#39;</span>),</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;                <span class="stringliteral">&#39;candidate&#39;</span>=&gt; _(<span class="stringliteral">&#39;Candidate&#39;</span>),</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;                <span class="stringliteral">&#39;qualified_candidate&#39;</span>=&gt; _(<span class="stringliteral">&#39;Qualified candidate&#39;</span>),</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;                <span class="stringliteral">&#39;lecturer&#39;</span>=&gt; _(<span class="stringliteral">&#39;Lecturer&#39;</span>),</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                <span class="stringliteral">&#39;qualified_lecturer&#39;</span>=&gt; _(<span class="stringliteral">&#39;Qualified lecturer&#39;</span>),</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        );</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        $inputs[<span class="stringliteral">&#39;roles&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>] = array(</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;                <span class="stringliteral">&#39;admin&#39;</span>=&gt; _(<span class="stringliteral">&#39;Admin&#39;</span>),</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                <span class="stringliteral">&#39;tutor&#39;</span>=&gt; _(<span class="stringliteral">&#39;Tutor&#39;</span>),</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        );</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        $inputs[<span class="stringliteral">&#39;school&#39;</span>][<span class="stringliteral">&#39;autocomplete&#39;</span>] = $DB-&gt;query(<span class="stringliteral">&#39;SELECT school FROM table_users WHERE school IS NOT NULL</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="stringliteral">                GROUP BY school HAVING count(*)&gt;1 ORDER BY count(*) DESC LIMIT 150&#39;</span>)-&gt;fetch_column();</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        $inputs[<span class="stringliteral">&#39;graduationyear&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>] = <a class="code" href="profile_8php.html#a6e25cefab90ef44a1ae9cbfb47ad4f22">getGraduationYearOptions</a>();</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        $form = <span class="keyword">new</span> <a class="code" href="classForm.html">Form</a>($inputs);</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        $form-&gt;columnWidth = <span class="stringliteral">&#39;35%&#39;</span>;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        <span class="keywordflow">if</span> ($form-&gt;submitted())</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        {</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                $values = $form-&gt;fetchAndValidateValues();</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;                <span class="keywordflow">if</span> ($form-&gt;valid)</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                {</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                        <span class="comment">// Update roles (in table_user_roles and table_edition_users.{lecturer,qualified}.</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                        <span class="keywordflow">if</span> ($admin)</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                        {</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                                $role = $values[<span class="stringliteral">&#39;role&#39;</span>];</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                                unset($values[<span class="stringliteral">&#39;role&#39;</span>]);</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                                $roles = array();</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                                <span class="keywordflow">if</span> (isset($_POST[<span class="stringliteral">&#39;roles&#39;</span>]) &amp;&amp; is_array($_POST[<span class="stringliteral">&#39;roles&#39;</span>])) <span class="comment">//test for empty checkboxGroup</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;                                        $roles = $_POST[<span class="stringliteral">&#39;roles&#39;</span>];</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                                <span class="keywordflow">if</span> ($role == <span class="stringliteral">&#39;none&#39;</span>)</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                                        $DB-&gt;edition_users($currentEdition, $uid)-&gt;delete();</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                                {</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                                        $value = array(</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                                                <span class="stringliteral">&#39;qualified&#39;</span> =&gt; (strpos($role, <span class="stringliteral">&#39;qualified&#39;</span>) !== <span class="keyword">false</span>) ? 1 : 0,</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                                                <span class="stringliteral">&#39;lecturer&#39;</span> =&gt;  (strpos($role, <span class="stringliteral">&#39;lecturer&#39;</span>)  !== <span class="keyword">false</span>) ? 1 : 0,</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                                        );</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                                        <span class="keywordflow">if</span> ($DB-&gt;edition_users($currentEdition, $uid)-&gt;count())</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                                                $DB-&gt;edition_users($currentEdition, $uid)-&gt;update($value);</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;                                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                                        {</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                                                $value[<span class="stringliteral">&#39;edition&#39;</span>] = $currentEdition;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                                                $value[<span class="stringliteral">&#39;uid&#39;</span>] = $uid;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                                                $DB-&gt;edition_users[]= $value;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                                        }</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                                }</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                                $DB-&gt;query(<span class="stringliteral">&#39;DELETE FROM table_user_roles WHERE uid=$1&#39;</span>, $uid);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                                <span class="keywordflow">foreach</span> ($roles as $role)</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                                        $DB-&gt;user_roles[]= array(<span class="stringliteral">&#39;uid&#39;</span>=&gt;$uid,<span class="stringliteral">&#39;role&#39;</span>=&gt;$role);</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                        }</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;                        <span class="comment">// ordername of &#39;Tom Marvolo Riddle&#39; is &#39;Riddle Tom Marvolo 666&#39;.</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                        <span class="keywordflow">if</span> (isset($values[<span class="stringliteral">&#39;name&#39;</span>]))</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                        {</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                                $nameParts = explode(<span class="charliteral">&#39; &#39;</span>, $values[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                                array_unshift($nameParts, array_pop($nameParts));</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                                $nameParts[]= $uid;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                                $values[<span class="stringliteral">&#39;ordername&#39;</span>] = implode(<span class="charliteral">&#39; &#39;</span>, $nameParts);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                        }</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;                        $DB-&gt;users[$uid]-&gt;update($values);</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                        $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;Saved.&#39;</span>), <span class="stringliteral">&#39;success&#39;</span>);</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                        <a class="code" href="log_8php.html#a5eaecfade7f5e117c98d7635b2aba95f">logUser</a>(<span class="stringliteral">&#39;user edit&#39;</span>, $uid);</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                }</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        }</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        $form-&gt;values = $DB-&gt;users[$uid]-&gt;assoc($form-&gt;getColumns() .<span class="stringliteral">&#39;,&quot;confirm&quot;&#39;</span>);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <span class="keywordflow">if</span> (isset($form[<span class="stringliteral">&#39;registered&#39;</span>]))</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                $form[<span class="stringliteral">&#39;registered&#39;</span>][<span class="stringliteral">&#39;description&#39;</span>] = <a class="code" href="user_2utils_8php.html#a7144fa5a413ad5690425b7b720aeedba">genderize</a>($form[<span class="stringliteral">&#39;registered&#39;</span>][<span class="stringliteral">&#39;description&#39;</span>], $form-&gt;values[<span class="stringliteral">&#39;gender&#39;</span>]);</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        $roles = $DB-&gt;query(<span class="stringliteral">&#39;SELECT role FROM table_user_roles WHERE uid=$1&#39;</span>, $uid);</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        $form-&gt;values[<span class="stringliteral">&#39;roles&#39;</span>] = array_intersect($roles-&gt;fetch_column(), array_keys($inputs[<span class="stringliteral">&#39;roles&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>]));</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        $row = $DB-&gt;edition_users($currentEdition, $uid);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        <span class="keywordflow">if</span> (!$row-&gt;count())</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                $form-&gt;values[<span class="stringliteral">&#39;role&#39;</span>] = <span class="stringliteral">&#39;none&#39;</span>;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        {</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                $form-&gt;values[<span class="stringliteral">&#39;role&#39;</span>] =  $row-&gt;get(<span class="stringliteral">&#39;qualified&#39;</span>) ? <span class="stringliteral">&#39;qualified_&#39;</span> : <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                $form-&gt;values[<span class="stringliteral">&#39;role&#39;</span>] .= $row-&gt;get(<span class="stringliteral">&#39;lecturer&#39;</span>) ? <span class="stringliteral">&#39;lecturer&#39;</span> : <span class="stringliteral">&#39;candidate&#39;</span>;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        }</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        <span class="keywordflow">if</span> ($admin)</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        {</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                <span class="keywordflow">if</span> ($form-&gt;values[<span class="stringliteral">&#39;confirm&#39;</span>] &gt; 0)</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                {</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                        $form-&gt;values[<span class="stringliteral">&#39;logged&#39;</span>] = _(<span class="stringliteral">&#39;the user hasn\&#39;t confirmed his e-mail yet&#39;</span>);</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                        $form[<span class="stringliteral">&#39;logged&#39;</span>][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;text&#39;</span>;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                }</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($form-&gt;values[<span class="stringliteral">&#39;logged&#39;</span>] == 0)</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                {</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                        $form-&gt;values[<span class="stringliteral">&#39;logged&#39;</span>] = _(<span class="stringliteral">&#39;the user hasn\&#39;t logged in yet&#39;</span>);</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                        $form[<span class="stringliteral">&#39;logged&#39;</span>][<span class="stringliteral">&#39;type&#39;</span>] = <span class="stringliteral">&#39;text&#39;</span>;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                }</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        }</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        <span class="comment">// Avatar uploader.</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        $uploader = array(</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                <span class="stringliteral">&#39;request&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                        <span class="stringliteral">&#39;endpoint&#39;</span> =&gt; <span class="stringliteral">&#39;fineuploader/handle.php&#39;</span>,</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                        <span class="stringliteral">&#39;params&#39;</span> =&gt; array(<span class="stringliteral">&#39;uid&#39;</span> =&gt; $uid)</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                ),</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                <span class="stringliteral">&#39;validation&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                        <span class="stringliteral">&#39;allowedExtensions&#39;</span> =&gt; array(<span class="stringliteral">&#39;jpeg&#39;</span>, <span class="stringliteral">&#39;jpg&#39;</span>),</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                        <span class="stringliteral">&#39;sizeLimit&#39;</span> =&gt; 5 * 1024 * 1024, <span class="comment">// 5M</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                ),</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                <span class="stringliteral">&#39;debug&#39;</span> =&gt; <span class="keyword">true</span>, <span class="comment">// log messages in browser console</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                <span class="stringliteral">&#39;multiple&#39;</span> =&gt; <span class="keyword">false</span>,</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                <span class="stringliteral">&#39;text&#39;</span> =&gt; array(<span class="stringliteral">&#39;uploadButton&#39;</span> =&gt; _(<span class="stringliteral">&#39;Upload&#39;</span>))</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        );</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>-&gt;jsOnLoad .= <span class="stringliteral">&#39;var avatarUploader = $(&quot;#avatarUpload&quot;).fineUploader(&#39;</span>.</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                json_encode($uploader) .<span class="charliteral">&#39;)&#39;</span>.</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                <span class="stringliteral">&#39;.on(&quot;complete&quot;, function(event, id, fileName, responseJSON) {</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="stringliteral">                        if (responseJSON.success) {</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="stringliteral">                                $(&quot;#avatar&quot;).attr(&quot;src&quot;,</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="stringliteral">                                        &quot;&#39;</span>. <a class="code" href="profile_8php.html#a0c599d4d650d9e6be9ff83f387f2a54a">getAvatarPath</a>($uid) .<span class="stringliteral">&#39;?&quot;+ new Date().getTime());</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="stringliteral">                                setTimeout(function(){ $(&quot;#avatarUpload&quot;).fineUploader(&quot;reset&quot;); }, 3000);</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="stringliteral">                        } });</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="stringliteral">        &#39;</span>;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        <span class="keywordflow">return</span> print $form-&gt;getHTML();</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;}</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div>
<div class="line"><a name="l00275"></a><span class="lineno"><a class="code" href="profile_8php.html#a91891599d32d0aa284d8690d6f0e090e">  275</a></span>&#160;<span class="keyword">function</span> <a class="code" href="profile_8php.html#a91891599d32d0aa284d8690d6f0e090e">actionHandleAvatarUpload</a>()</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;{</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        exit;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;}</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div>
<div class="line"><a name="l00280"></a><span class="lineno"><a class="code" href="profile_8php.html#aa3f448ae5d33ace19fe4b1d30bbc73ba">  280</a></span>&#160;<span class="keyword">function</span> <a class="code" href="profile_8php.html#aa3f448ae5d33ace19fe4b1d30bbc73ba">actionEditAdditionalInfo</a>($uid = null)</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;{</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        global $USER, <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>, <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>;</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        $edition = <a class="code" href="utils_8php.html#a86acce3c002ca1af709fd1b04f2f82fa">getOption</a>(<span class="stringliteral">&#39;currentEdition&#39;</span>);</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        $admin = !is_null($uid) &amp;&amp; $uid != $USER[<span class="stringliteral">&#39;uid&#39;</span>];</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        <span class="keywordflow">if</span> ($admin)</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        {</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;adminUsers&#39;</span>))  <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classPolicyException.html">PolicyException</a>();</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                $uid = intval($uid);</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        }</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        {</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;editAdditionalInfo&#39;</span>))  <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classPolicyException.html">PolicyException</a>();</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                $uid = intval($USER[<span class="stringliteral">&#39;uid&#39;</span>]);</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        }</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        $r = $DB-&gt;users[$uid]-&gt;assoc(<span class="stringliteral">&#39;pesel,address,telephone,parenttelephone,gatherplace,tshirtsize,comments,name&#39;</span>);</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        $PAGE-&gt;title = _(<span class="stringliteral">&#39;Additional info&#39;</span>);</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        <span class="keywordflow">if</span> ($admin)  $PAGE-&gt;title = $r[<span class="stringliteral">&#39;name&#39;</span>] .<span class="stringliteral">&#39; - &#39;</span>. $PAGE-&gt;title;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;adminUsers&#39;</span>))</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                $PAGE-&gt;headerTitle = <a class="code" href="admin_8php.html#a9cfe349e8c7f62fd2a38c48f80b90028">getUserHeader</a>($uid, $r[<span class="stringliteral">&#39;name&#39;</span>], <span class="stringliteral">&#39;editAdditionalInfo&#39;</span>);</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        <span class="keywordflow">if</span> (!$DB-&gt;edition_users($edition, $uid)-&gt;count())</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        {</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                <span class="keywordflow">if</span> ($admin)</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                        $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;The user hasn\&#39;t signed up for this edition yet.&#39;</span>));</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                        $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;You should first sign up as a participant or lecturer.&#39;</span>));</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        }</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        $inputs = <a class="code" href="utils_8php.html#ae70693a7d9a8484219fe57bdf2d2a46f">parseTable</a>(<span class="stringliteral">&#39;</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="stringliteral">                NAME            =&gt; TYPE;     tDESCRIPTION;                                         VALIDATION</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="stringliteral">                pesel           =&gt; text;     PESEL number;                                         length(0 11),char(digit);</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="stringliteral">                address         =&gt; textarea; address &lt;small&gt;(for the insurance)&lt;/small&gt;;           ;</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="stringliteral">                telephone       =&gt; text;     telephone;                                            longer(6);</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="stringliteral">                parenttelephone =&gt; text;     telephone to your parents/carers;                     ;</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="stringliteral">                staybegintime   =&gt; select;   staying time: &lt;span class=&quot;right&quot;&gt;from&lt;/span&gt;;        int;</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="stringliteral">                stayendtime     =&gt; select;                 &lt;span class=&quot;right&quot;&gt;to&lt;/span&gt;;          int;</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="stringliteral">                gatherplace     =&gt; select;   I\&#39;ll join the gathering at;                          ;     default=&gt;none;</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="stringliteral">                isselfcatered   =&gt; checkbox; accomodation and meals;                               ;</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="stringliteral">                tshirtsize      =&gt; select;   preferred t-shirt size;                               ;     default=&gt;L;</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="stringliteral">                comments        =&gt; textarea; comments (e.g. vegetarian);                           ;</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="stringliteral">        &#39;</span>);</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="user_2utils_8php.html#ae6297fbd3e8fa7cc5feb6411a80deee9">userIs</a>(<span class="stringliteral">&#39;lecturer&#39;</span>))</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                unset($inputs[<span class="stringliteral">&#39;parenttelephone&#39;</span>]);</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        $data = $DB-&gt;editions[$edition]-&gt;assoc(<span class="charliteral">&#39;*&#39;</span>);</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        $starttime = $data[<span class="stringliteral">&#39;begintime&#39;</span>];</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        $starttime -= 60*60*strftime(<span class="stringliteral">&#39;%H&#39;</span>, $starttime);</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        $hours = explode(<span class="charliteral">&#39; &#39;</span>, $data[<span class="stringliteral">&#39;importanthours&#39;</span>]);</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        $stayoptions = array();</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        $inputs[<span class="stringliteral">&#39;staybegintime&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>] = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        <span class="keywordflow">for</span> ($day=0; $starttime + $day*24*60*60 &lt;= $data[<span class="stringliteral">&#39;endtime&#39;</span>]; $day++)</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                <span class="keywordflow">foreach</span> ($hours as $h)</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        {</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                $time = $starttime+($day*24+$h)*60*60;</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                <span class="keywordflow">if</span> ($time &gt;= $data[<span class="stringliteral">&#39;begintime&#39;</span>] &amp;&amp; $time &lt;= $data[<span class="stringliteral">&#39;endtime&#39;</span>])</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                        $stayoptions[$time] = strftime(<span class="stringliteral">&#39;%e. (%a) %H:%M&#39;</span>, $time);</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                <span class="keywordflow">if</span> (!$inputs[<span class="stringliteral">&#39;staybegintime&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>])</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                        $inputs[<span class="stringliteral">&#39;staybegintime&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>] = $time;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                $inputs[<span class="stringliteral">&#39;stayendtime&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>] = $time;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        }</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        $inputs[<span class="stringliteral">&#39;staybegintime&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>] = $stayoptions;</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        $inputs[<span class="stringliteral">&#39;stayendtime&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>]   = $stayoptions;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        $inputs[<span class="stringliteral">&#39;gatherplace&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>] = array(<span class="stringliteral">&#39;warszawa&#39;</span>=&gt;_(<span class="stringliteral">&#39;Warsaw PKP&#39;</span>),<span class="stringliteral">&#39;wroclaw&#39;</span>=&gt;_(<span class="stringliteral">&#39;Wrocław Główny&#39;</span>),<span class="stringliteral">&#39;glogow&#39;</span>=&gt;_(<span class="stringliteral">&#39;Głogów PKP&#39;</span>),<span class="stringliteral">&#39;none&#39;</span>=&gt;_(<span class="stringliteral">&#39;I\&#39;ll arrive on my own.&#39;</span>));</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        $tshirtsizes = array(<span class="stringliteral">&#39;XS&#39;</span>,<span class="charliteral">&#39;S&#39;</span>,<span class="charliteral">&#39;M&#39;</span>,<span class="charliteral">&#39;L&#39;</span>,<span class="stringliteral">&#39;XL&#39;</span>,<span class="stringliteral">&#39;XXL&#39;</span>);</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        $inputs[<span class="stringliteral">&#39;tshirtsize&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>] = array_combine($tshirtsizes, $tshirtsizes);;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        $inputs[<span class="stringliteral">&#39;isselfcatered&#39;</span>][<span class="stringliteral">&#39;text&#39;</span>] = _(<span class="stringliteral">&#39;on my own&#39;</span>) .</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                <span class="stringliteral">&#39;&lt;small &#39;</span>. <a class="code" href="template_8php.html#a9b9585537fe5238d4d5b54478251ccfa">getTipJS</a>(_(<span class="stringliteral">&#39;applies to Głogów residents, for example&#39;</span>)) .<span class="stringliteral">&#39;&gt;[?]&lt;/small&gt;&#39;</span>;</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        $form = <span class="keyword">new</span> <a class="code" href="classForm.html">Form</a>($inputs);</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        $editionColumns = array(<span class="stringliteral">&#39;staybegintime&#39;</span>,<span class="stringliteral">&#39;stayendtime&#39;</span>,<span class="stringliteral">&#39;isselfcatered&#39;</span>);</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        <span class="keywordflow">if</span> ($form-&gt;submitted() &amp;&amp; !$admin)</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        {</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                $values = $form-&gt;fetchAndValidateValues();</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                <span class="keywordflow">if</span> ($form-&gt;valid)</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                {</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                        $editionValues = array();</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                        <span class="keywordflow">foreach</span> ($editionColumns as $column)</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                        {</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                                $editionValues[$column] = $values[$column];</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                                unset($values[$column]);</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                        }</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                        $editionValues[<span class="stringliteral">&#39;lastmodification&#39;</span>] = time();</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;                        $DB-&gt;users[$uid]-&gt;update($values);</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                        $DB-&gt;edition_users($edition, $uid)-&gt;update($editionValues);</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                        $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;Saved.&#39;</span>), <span class="stringliteral">&#39;success&#39;</span>);</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                        <a class="code" href="log_8php.html#a5eaecfade7f5e117c98d7635b2aba95f">logUser</a>(<span class="stringliteral">&#39;user edit2&#39;</span>, $uid);</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                }</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        }</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        <span class="keywordflow">if</span> (is_null($r[<span class="stringliteral">&#39;tshirtsize&#39;</span>]))  $r[<span class="stringliteral">&#39;tshirtsize&#39;</span>] = <span class="charliteral">&#39;L&#39;</span>;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        $r += $DB-&gt;edition_users($edition,$uid)-&gt;assoc(implode(<span class="charliteral">&#39;,&#39;</span>,$editionColumns));</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        $stayoptions = array_keys($stayoptions);</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        <span class="keywordflow">if</span> (!in_array($r[<span class="stringliteral">&#39;staybegintime&#39;</span>], $stayoptions))</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                $r[<span class="stringliteral">&#39;staybegintime&#39;</span>] = $stayoptions[0];</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        <span class="keywordflow">if</span> (!in_array($r[<span class="stringliteral">&#39;stayendtime&#39;</span>], $stayoptions))</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                $r[<span class="stringliteral">&#39;stayendtime&#39;</span>] = $stayoptions[count($stayoptions) - 1];</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;        $form-&gt;values = $r;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        $form-&gt;columnWidth = <span class="stringliteral">&#39;25%&#39;</span>;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        <span class="keywordflow">if</span> ($admin)</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                $form-&gt;submitValue = null;</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        <span class="keywordflow">return</span> print $form-&gt;getHTML();</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;}</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;</div>
<div class="line"><a name="l00395"></a><span class="lineno"><a class="code" href="profile_8php.html#ad603b73d651c86d7ae2bf48c936712cc">  395</a></span>&#160;<span class="keyword">function</span> <a class="code" href="profile_8php.html#ad603b73d651c86d7ae2bf48c936712cc">actionEditMotivationLetter</a>()</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;{</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a1e9c8ed2c5ed2def1a367c9ffd04114b">userCan</a>(<span class="stringliteral">&#39;editMotivationLetter&#39;</span>))  <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classPolicyException.html">PolicyException</a>();</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        global $USER, <a class="code" href="index_8php.html#ae1848ae8dc4014bc7c680e5504a8eef0">$PAGE</a>, <a class="code" href="common_8php.html#a7dc56dc8b18ad37272b56fa7395bedef">$DB</a>;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        $PAGE-&gt;title = _(<span class="stringliteral">&#39;Motivation letter&#39;</span>);</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="user_2utils_8php.html#a5bbc4a39c360e15b0c00714f18d2082b">assertProfileFilled</a>())  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        $inputs = <a class="code" href="utils_8php.html#ae70693a7d9a8484219fe57bdf2d2a46f">parseTable</a>(<span class="stringliteral">&#39;</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="stringliteral">                NAME               =&gt; TYPE;</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="stringliteral">                motivationletter   =&gt; richtextarea;</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;<span class="stringliteral">        &#39;</span>);</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        $inputs[<span class="stringliteral">&#39;motivationletter&#39;</span>][<span class="stringliteral">&#39;description&#39;</span>] = sprintf(<a class="code" href="user_2utils_8php.html#a7144fa5a413ad5690425b7b720aeedba">genderize</a>(_(</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                         <span class="stringliteral">&#39;Write (in %d - %d words) referring to each point in a separate paragraph:&lt;br/&gt;&#39;</span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;                        .<span class="stringliteral">&#39;1. Describe your main scientific interests. A detailed description would be welcome (if you’re interested in mathematics - which area are you most interested in; if it’s programming - what programs are you making and in what language, etc.).&lt;br/&gt;&#39;</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;                        .<span class="stringliteral">&#39;2. How do you develop your interests from section 1.? Write down what books you read, what type of tasks and problems you solve, etc. If you have your own projects, works, experiments, programs - describe them. If you’re a member of Polish Children’s Fund, briefly describe what you do in the program.&lt;br/&gt;&#39;</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                        .<span class="stringliteral">&#39;3. If you’re interested in something not strictly scientific (that is, besides math/physics/computer science) or you are involved in other initiatives, describe them briefly.&lt;br/&gt;&#39;</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                        .<span class="stringliteral">&#39;4. If you participate in competitions or olympic contests, describe your achievements (participation, awards).&lt;br/&gt;&#39;</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;                        .<span class="stringliteral">&#39;5. About which of your interests would you tell others most preferably?&lt;br/&gt;&#39;</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;                        .<span class="stringliteral">&#39;6. What do you expect from your participation in WWW, what encouraged you to apply? If you want to contribute somehow (organise something, give an evening lecture, etc.), describe it.&lt;br/&gt;&#39;</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                        .<span class="stringliteral">&#39;7. Are you willing to give a 15-minute speech at WWW (which would be appreciated)? If so, describe its title and topic. If you are not sure about what you want to say, please contact us.&lt;br/&gt;&#39;</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                        .<span class="stringliteral">&#39;8. Here you can write anything which didn’t fit in sections 1.-7. &lt;br/&gt;&#39;</span>)),</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                <a class="code" href="utils_8php.html#a86acce3c002ca1af709fd1b04f2f82fa">getOption</a>(<span class="stringliteral">&#39;motivationLetterWords&#39;</span>), 1000); <span class="comment">//TODO maybe set it as option?</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        $form = <span class="keyword">new</span> <a class="code" href="classForm.html">Form</a>($inputs);</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        <span class="keywordflow">if</span> ($form-&gt;submitted())</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;        {</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                $values = $form-&gt;fetchAndValidateValues();</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                <span class="keywordflow">if</span> ($form-&gt;valid)</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                {</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                        $DB-&gt;users[$USER[<span class="stringliteral">&#39;uid&#39;</span>]]-&gt;update($values);</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                        $PAGE-&gt;addMessage(_(<span class="stringliteral">&#39;Your motivation letter has been saved.&#39;</span>), <span class="stringliteral">&#39;success&#39;</span>);</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                        <a class="code" href="log_8php.html#a5eaecfade7f5e117c98d7635b2aba95f">logUser</a>(<span class="stringliteral">&#39;user edit3&#39;</span>);</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                }</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        }</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        $form-&gt;values = $DB-&gt;users[$USER[<span class="stringliteral">&#39;uid&#39;</span>]]-&gt;assoc($form-&gt;getColumns());</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        <span class="keywordflow">return</span> print $form-&gt;getHTML();</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;}</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="comment">// Returns an array of 9 most probable graduation years.</span></div>
<div class="line"><a name="l00436"></a><span class="lineno"><a class="code" href="profile_8php.html#a6e25cefab90ef44a1ae9cbfb47ad4f22">  436</a></span>&#160;<span class="keyword">function</span> <a class="code" href="profile_8php.html#a6e25cefab90ef44a1ae9cbfb47ad4f22">getGraduationYearOptions</a>($withComment = <span class="keyword">false</span>)</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;{</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        <span class="comment">// I decided not to use the text descriptions anymore, they&#39;re imprecise and confusing.</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        <span class="comment">// (so this table&#39;s values are not actually used).</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;        $classOptions = array(<span class="stringliteral">&#39;3. gimnazjum &#39;</span>, <span class="stringliteral">&#39;1. klasa liceum&#39;</span>,<span class="stringliteral">&#39;2. klasa liceum &#39;</span>, <span class="stringliteral">&#39;3. klasa liceum&#39;</span>,</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;                <span class="stringliteral">&#39;I rok studiów&#39;</span>, <span class="stringliteral">&#39;II  rok studiów&#39;</span>, <span class="stringliteral">&#39;III rok studiów&#39;</span>, <span class="stringliteral">&#39;IV rok studiów&#39;</span>, <span class="stringliteral">&#39;V rok studiów&#39;</span>);</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        $date = getdate();</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        $year = $date[<span class="stringliteral">&#39;year&#39;</span>]+3; <span class="comment">// The first element of $classOptions graduates in 3 years.</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <span class="keywordflow">if</span> ($date[<span class="stringliteral">&#39;mon&#39;</span>]&gt;=9)</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                $year++; <span class="comment">// We consider the 1st of September to be the threshold (should we?).</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        $graduationYearOptions = array();</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        <span class="keywordflow">foreach</span> ($classOptions as $i=&gt;$opt)</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;        {</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;                $s = $year;</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                <span class="keywordflow">if</span> ($withComment)  $s .= <span class="stringliteral">&quot; (~$opt)&quot;</span>;</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                $graduationYearOptions[$year] = $s;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                $year--;</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        }</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;        <span class="keywordflow">return</span> $graduationYearOptions;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Sep 8 2013 17:44:57 for wwwApp by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.1
</small></address>
</body>
</html>
